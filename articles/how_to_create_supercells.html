<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="SuperCellCyto">
<title>How to create supercells • SuperCellCyto</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="How to create supercells">
<meta property="og:description" content="SuperCellCyto">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">SuperCellCyto</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/how_to_create_supercells.html">How to create supercells</a>
    <a class="dropdown-item" href="../articles/how_to_prepare_data.html">Preparing Data for SuperCellCyto</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>How to create supercells</h1>
                        <h4 data-toc-skip class="author">Givanna
Putri</h4>
            
      
      
      <div class="d-none name"><code>how_to_create_supercells.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette describes the steps to reduce the size of vast
high-dimensional cytometry data using SuperCellCyto, an R package based
on the <a href="https://github.com/GfellerLab/SuperCell" class="external-link">SuperCell R
package</a> by David Gfeller lab from the University of Lausanne.</p>
<p>Please note that we’re still actively updating this vignette (and in
fact the package itself), and that we welcome any feedbacks on how to
improve them. There are myriad of ways on how to use SuperCell. While we
try to cover as many use cases as possible, we bound to miss something.
In that case, please reach out through the github repository by creating
a Github issue.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>To install SuperCellCyto, we need to use the
<code>remotes`` package from CRAN.  You can install</code>remotes<code>by using the</code>install.packages(“remotes”)`
command.</p>
<p>Thereafter, you can install SuperCellCyto using
<code>remotes::install_github("phipsonlab/SuperCellCyto")</code>.</p>
<p>SuperCellCyto requires the <a href="https://github.com/GfellerLab/SuperCell" class="external-link">SuperCell R package</a>
installed to run properly. If you use the
<code><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">remotes::install_github</a></code> command above to install
SuperCellCyto, it should be, in theory, automatically installed. But in
the case it doesn’t, you can manually install it by using
<code>remotes::install_github("GfellerLab/SuperCell")</code>.</p>
</div>
<div class="section level2">
<h2 id="preparing-your-dataset">Preparing your dataset<a class="anchor" aria-label="anchor" href="#preparing-your-dataset"></a>
</h2>
<p>The function which creates supercells is called
<code>runSuperCellCyto</code>, and it operates on a
<code>data.table</code> object, an enhanced version of R native
<code>data.frame</code>.</p>
<p>If the raw data is stored in a csv file, we can import it into a
<code>data.table</code> object using their <code>fread</code>
function.</p>
<p>If the raw data is stored across multiple csv files or FCS files
(more common for cytometry), then we will need the help of <a href="https://github.com/ImmuneDynamics/Spectre" class="external-link">Spectre</a> R package
to import them as a<code>data.table</code> object. Specifically, we need
to:</p>
<ol style="list-style-type: decimal">
<li>Run <code>read.files</code> function to read in the FCS or csv
files.</li>
<li>Run <code>do.merge.files</code> to merge the resulting
<code>data.table</code> objects into one.</li>
</ol>
<p>If you are unsure as to how these steps will work out, have a look at
an example in this <a href="https://immunedynamics.io/spectre/simple-discovery/#2_Import_and_prep_data" class="external-link">Spectre
vignette</a>.</p>
<p>Using the vignette above, if you have csv files, you can run the
steps in that vignette as they are, <strong><em>but</em></strong> only
after changing the <code>InputDirectory</code> variable. If you have FCS
files, you need to change the <code>file.type</code> parameter for the
<code>read.files</code> function to <code>.fcs</code>.</p>
<p>For this vignette, we will simulate some toy data using the
<code>simCytoData</code> function.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_markers</span> <span class="op">&lt;-</span> <span class="fl">15</span></span>
<span><span class="va">n_samples</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">SuperCellCyto</span><span class="fu">::</span><span class="fu"><a href="../reference/simCytoData.html">simCytoData</a></span><span class="op">(</span>nmarkers <span class="op">=</span> <span class="va">n_markers</span>, ncells <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">10000</span>, <span class="va">n_samples</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Marker_1 Marker_2  Marker_3 Marker_4  Marker_5 Marker_6  Marker_7 Marker_8</span></span>
<span><span class="co">#&gt; 1: 16.25606 18.14575  9.548869 12.17178  9.028273 15.61863 13.662919 19.26841</span></span>
<span><span class="co">#&gt; 2: 16.82141 19.40778 11.555141 13.19103 11.629131 15.92035 10.771203 19.76645</span></span>
<span><span class="co">#&gt; 3: 16.40205 16.53930 11.315043 11.98860 10.302833 15.62479  8.719536 20.06792</span></span>
<span><span class="co">#&gt; 4: 18.16170 19.51574 10.555033 13.30105  8.201412 15.75832 12.218257 19.65611</span></span>
<span><span class="co">#&gt; 5: 16.07364 19.58259 10.410142 12.50632 10.797509 13.48594 12.002132 17.89459</span></span>
<span><span class="co">#&gt; 6: 17.26863 18.69557 11.668230 12.98325  8.077308 16.24577 12.168319 18.15234</span></span>
<span><span class="co">#&gt;    Marker_9 Marker_10 Marker_11 Marker_12 Marker_13 Marker_14 Marker_15</span></span>
<span><span class="co">#&gt; 1: 9.109605  16.19939  6.801168 10.568241  3.745733  6.772636  12.48848</span></span>
<span><span class="co">#&gt; 2: 7.236498  16.50387  6.404580 10.679662  5.448163  7.931340  13.52207</span></span>
<span><span class="co">#&gt; 3: 8.948140  17.74711  6.185180  7.817153  5.079171  7.516630  12.90391</span></span>
<span><span class="co">#&gt; 4: 7.376460  16.09171  5.819895  6.993930  6.544952  7.757599  13.14264</span></span>
<span><span class="co">#&gt; 5: 8.445737  17.98175  7.012131  9.006179  5.409446  8.066357  12.47985</span></span>
<span><span class="co">#&gt; 6: 9.470536  15.23757  6.380078  8.955770  8.256096  8.841446  11.84725</span></span>
<span><span class="co">#&gt;      Sample Cell_Id</span></span>
<span><span class="co">#&gt; 1: Sample_1  Cell_1</span></span>
<span><span class="co">#&gt; 2: Sample_1  Cell_2</span></span>
<span><span class="co">#&gt; 3: Sample_1  Cell_3</span></span>
<span><span class="co">#&gt; 4: Sample_1  Cell_4</span></span>
<span><span class="co">#&gt; 5: Sample_1  Cell_5</span></span>
<span><span class="co">#&gt; 6: Sample_1  Cell_6</span></span></code></pre></div>
<p>There are several things to note about our dataset. Let’s go through
them one by one in each sub-section below.</p>
<div class="section level3">
<h3 id="the-markers">The markers<a class="anchor" aria-label="anchor" href="#the-markers"></a>
</h3>
<p>The <code>runSuperCellCyto</code> function does not perform any data
transformation or scaling. Thus, we must ensure that our dataset have
already been appropriately transformed using either the arc-sinh
transformation or linear binning (using FlowJo). This tutorial explains
the data transformation process in very great detail: (<a href="https://wiki.centenary.org.au/display/SPECTRE/Data+transformation" class="external-link uri">https://wiki.centenary.org.au/display/SPECTRE/Data+transformation</a>).
Please have a read if you are unsure how to transform your data.</p>
<p>For our toy dataset, we will transform our data using the arc-sinh
transformation implementation provided by the base R <code>asinh</code>
function:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Specify which columns are the markers to transform</span></span>
<span><span class="va">marker_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Marker_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_markers</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># The co-factor for arc-sinh</span></span>
<span><span class="va">cofactor</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span></span>
<span><span class="co"># Do the transformation</span></span>
<span><span class="va">dat_asinh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Hyperbolic.html" class="external-link">asinh</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[</span>, <span class="va">marker_cols</span>, with <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span> <span class="op">/</span> <span class="va">cofactor</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rename the new columns</span></span>
<span><span class="va">marker_cols_asinh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">marker_cols</span>, <span class="st">"_asinh"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat_asinh</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">marker_cols_asinh</span></span>
<span></span>
<span><span class="co"># Add them our previously loaded data</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">dat_asinh</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[</span>, <span class="va">marker_cols_asinh</span>, with <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Marker_1_asinh Marker_2_asinh Marker_3_asinh Marker_4_asinh Marker_5_asinh</span></span>
<span><span class="co">#&gt; 1:       1.895028       2.000608       1.402541       1.622572       1.353184</span></span>
<span><span class="co">#&gt; 2:       1.927752       2.065578       1.574667       1.697371       1.580528</span></span>
<span><span class="co">#&gt; 3:       1.903577       1.911551       1.555429       1.608560       1.470398</span></span>
<span><span class="co">#&gt; 4:       2.001455       2.070951       1.492205       1.705142       1.270142</span></span>
<span><span class="co">#&gt; 5:       1.884247       2.074264       1.479729       1.647701       1.512773</span></span>
<span><span class="co">#&gt; 6:       1.952930       2.029416       1.583612       1.682540       1.257150</span></span>
<span><span class="co">#&gt;    Marker_6_asinh Marker_7_asinh Marker_8_asinh Marker_9_asinh Marker_10_asinh</span></span>
<span><span class="co">#&gt; 1:       1.856863       1.730309       2.058600       1.361037        1.891691</span></span>
<span><span class="co">#&gt; 2:       1.875101       1.510560       2.083321       1.165170        1.909499</span></span>
<span><span class="co">#&gt; 3:       1.857238       1.322871       2.098002       1.345393        1.979210</span></span>
<span><span class="co">#&gt; 4:       1.865346       1.626098       2.077895       1.180979        1.885320</span></span>
<span><span class="co">#&gt; 5:       1.718075       1.609602       1.987178       1.295305        1.991859</span></span>
<span><span class="co">#&gt; 6:       1.894423       1.622309       2.000958       1.395250        1.833366</span></span>
<span><span class="co">#&gt;    Marker_11_asinh Marker_12_asinh Marker_13_asinh Marker_14_asinh</span></span>
<span><span class="co">#&gt; 1:       1.1146489        1.493335       0.6924643        1.111264</span></span>
<span><span class="co">#&gt; 2:       1.0667615        1.502825       0.9433550        1.241683</span></span>
<span><span class="co">#&gt; 3:       1.0394688        1.229441       0.8925259        1.196607</span></span>
<span><span class="co">#&gt; 4:       0.9927073        1.137276       1.0839207        1.223006</span></span>
<span><span class="co">#&gt; 5:       1.1393915        1.351041       0.9381092        1.255996</span></span>
<span><span class="co">#&gt; 6:       1.0637423        1.346137       1.2758208        1.334936</span></span>
<span><span class="co">#&gt;    Marker_15_asinh</span></span>
<span><span class="co">#&gt; 1:        1.646375</span></span>
<span><span class="co">#&gt; 2:        1.720584</span></span>
<span><span class="co">#&gt; 3:        1.676822</span></span>
<span><span class="co">#&gt; 4:        1.693936</span></span>
<span><span class="co">#&gt; 5:        1.645734</span></span>
<span><span class="co">#&gt; 6:        1.597624</span></span></code></pre></div>
<p>Breaking down the steps, we:</p>
<ol style="list-style-type: decimal">
<li>Identify the columns denoting the markers.</li>
<li>Set the co-factor to 5.</li>
<li>Do the transformation and store it in <code>dat_asinh</code>
variable.</li>
<li>Set the <code>dat_asinh</code> column name to reflect that the
values in each column (marker) haas undergone an arc-sinh
transformation.</li>
<li>Combine <code>dat</code> and <code>dat_asinh</code> using
<code>cbind</code>.</li>
</ol>
</div>
<div class="section level3">
<h3 id="cell-id-column">Cell id column<a class="anchor" aria-label="anchor" href="#cell-id-column"></a>
</h3>
<p>To create supercell, we must provide a column which uniquely identify
each cell, akin to the <code>Cell_Id</code> column in the toy data we
generated above:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">Cell_Id</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "Cell_1"  "Cell_2"  "Cell_3"  "Cell_4"  "Cell_5"  "Cell_6"  "Cell_7" </span></span>
<span><span class="co">#&gt;  [8] "Cell_8"  "Cell_9"  "Cell_10"</span></span></code></pre></div>
<p>The purpose of cell id is to allow SuperCell to uniquely identify
each cell in the dataset. This ID will come in super handy later when/if
we need to work out which cells belong to which supercells.</p>
<p>Generally, we will need to create this ID ourselves. Most dataset
won’t come with this ID already embedded in. A simple cell id can be
made up by concatenating the word <code>Cell</code> with the row number.
Something like the following:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span><span class="op">$</span><span class="va">Cell_id_dummy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Cell_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">Cell_id_dummy</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "Cell_1"  "Cell_2"  "Cell_3"  "Cell_4"  "Cell_5"  "Cell_6"  "Cell_7" </span></span>
<span><span class="co">#&gt;  [8] "Cell_8"  "Cell_9"  "Cell_10"</span></span></code></pre></div>
<p>Here, we store the cell id in a column called
<code>Cell_id_dummy</code>. It has values such as
<code>Cell_1, Cell_2,</code> all the way until <code>Cell_x</code> where
x is the number of cells in the dataset.</p>
<p>Note, we can name the cell id column however we like,
<code>id, cell_identity</code>, etc. Importantly, we need make sure we
note the column name as we will need to pass it to the
<code>runSuperCellCyto</code> function later.</p>
</div>
<div class="section level3">
<h3 id="sample-column">Sample column<a class="anchor" aria-label="anchor" href="#sample-column"></a>
</h3>
<p>You will notice that in the toy data above, we have a column called
<code>Sample</code>. By default, this column refers to the biological
sample the cells come from. In the toy data above, we have 3 samples,
<code>Sample_1, Sample_2, Sample_3</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">Sample</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Sample_1" "Sample_2" "Sample_3"</span></span></code></pre></div>
<p>and we have 10,000 cells per sample:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">Sample</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample_1 Sample_2 Sample_3 </span></span>
<span><span class="co">#&gt;    10000    10000    10000</span></span></code></pre></div>
<p>To create supercells, it is necessary to have this
<code>Sample</code> column in our dataset. We can name the column
however we like, <code>Samp, Cell_Samp</code>. However, we make sure we
note the column name as we will need to pass it to the
<code>runSuperCellCyto</code> function. More on this in [Creating
supercells][#creating-supercells] section.</p>
<p>But what if we only have 1 biological sample in our dataset? It does
not matter. We still need to have this column in our dataset, and pass
the column name to the <code>runSuperCellCyto</code> function. The only
difference is that this column will only have 1 unique value.</p>
<p>Why do we need to do this? To ensure that each supercell only
contains cells from exactly 1 sample. This is because, in general, it
does not make sense to mix cells from different biological samples in
one supercell. Additionally (not as important), the
<code>runSuperCellCyto</code> function can process all the samples in
parallel if you set its <code>BPPARAM</code> parameter to a
<code>BiocParallelParam</code> class that leverage parallel processing.
More on this in <a href="#running-runsupercellcyto-in-parallel">Running
runSuperCellCyto in parallel</a> section below.</p>
<p>However, if you want each supercell to contain cells from different
biological samples, then you need to create a new <code>Sample</code>
column containing exactly 1 <strong><em>unique</em></strong> value, and
pass the column name to <code>runSuperCellCyto</code> function.</p>
<p>: You may wonder whether it is possible to use
<code>SuperCellCyto</code> to reduce the number of cells captured in
each cluster (or cell type) so we can make a UMAP/tSNE plot that is not
as crowded? Commonly in cytometry, we use stratified sampling to
subsample our clusters before drawing UMAP/tSNE plot to avoid
overcrowding it.</p>
<p>The short answer is, yes you can. See <a href="#using-runsupercellcyto-for-stratified-summarising">Using
runSuperCellCyto for stratified summarising</a> section for more
information.</p>
</div>
</div>
<div class="section level2">
<h2 id="creating-supercells">Creating supercells<a class="anchor" aria-label="anchor" href="#creating-supercells"></a>
</h2>
<p>Now that we have imported our data, let’s create some supercells.</p>
<p>First, let’s store the markers, sample, and cell id column in
variables:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">markers_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Marker_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_markers</span><span class="op">)</span>, <span class="st">"_asinh"</span><span class="op">)</span></span>
<span><span class="va">sample_col</span> <span class="op">&lt;-</span> <span class="st">"Sample"</span></span>
<span><span class="va">cell_id_col</span> <span class="op">&lt;-</span> <span class="st">"Cell_Id_dummy"</span></span></code></pre></div>
<p>Then pass all of that, together with the dataset into
<code>runSuperCellCyto</code> function to create supercells:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">supercells</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSuperCellCyto.html">runSuperCellCyto</a></span><span class="op">(</span></span>
<span>  dt <span class="op">=</span> <span class="va">dat</span>,</span>
<span>  markers <span class="op">=</span> <span class="va">markers_col</span>,</span>
<span>  sample_colname <span class="op">=</span> <span class="va">sample_col</span>,</span>
<span>  cell_id_colname <span class="op">=</span> <span class="va">cell_id_col</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in SCimplify(X = mt, genes.use = rownames(mt), do.scale = FALSE, : colnames(X) is Null, </span></span>
<span><span class="co">#&gt; Gene expression matrix X is expected to have cellIDs as colnames! </span></span>
<span><span class="co">#&gt; CellIDs will be created automatically in a form 'cell_i'</span></span>
<span></span>
<span><span class="co">#&gt; Warning in SCimplify(X = mt, genes.use = rownames(mt), do.scale = FALSE, : colnames(X) is Null, </span></span>
<span><span class="co">#&gt; Gene expression matrix X is expected to have cellIDs as colnames! </span></span>
<span><span class="co">#&gt; CellIDs will be created automatically in a form 'cell_i'</span></span>
<span></span>
<span><span class="co">#&gt; Warning in SCimplify(X = mt, genes.use = rownames(mt), do.scale = FALSE, : colnames(X) is Null, </span></span>
<span><span class="co">#&gt; Gene expression matrix X is expected to have cellIDs as colnames! </span></span>
<span><span class="co">#&gt; CellIDs will be created automatically in a form 'cell_i'</span></span></code></pre></div>
<p>Now let’s dig deeper into the object it created:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "list"</span></span></code></pre></div>
<p>It is a list containing 3 elements:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "supercell_expression_matrix" "supercell_cell_map"         </span></span>
<span><span class="co">#&gt; [3] "supercell_object"</span></span></code></pre></div>
<div class="section level3">
<h3 id="supercell-object">Supercell object<a class="anchor" aria-label="anchor" href="#supercell-object"></a>
</h3>
<p>The <code>supercell_object</code> contains the metadata used to
create the supercells. It is a list, and each element contains the
metadata used to create the supercells for a sample. This will come in
handy if we need to debug the supercells later down the line.</p>
</div>
<div class="section level3">
<h3 id="supercell-expression-matrix">Supercell expression matrix<a class="anchor" aria-label="anchor" href="#supercell-expression-matrix"></a>
</h3>
<p>The <code>supercell_expression_matrix</code> contains the marker
expression of each supercell. These are calculated by taking the average
of the marker expression of all the cells contained within a
supercell.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">$</span><span class="va">supercell_expression_matrix</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Marker_1_asinh Marker_2_asinh Marker_3_asinh Marker_4_asinh Marker_5_asinh</span></span>
<span><span class="co">#&gt; 1:       1.872852       2.019909       1.560188       1.610743       1.506353</span></span>
<span><span class="co">#&gt; 2:       1.875570       2.037811       1.684019       1.579263       1.396179</span></span>
<span><span class="co">#&gt; 3:       1.855086       2.009119       1.576249       1.662939       1.455503</span></span>
<span><span class="co">#&gt; 4:       1.822363       1.994605       1.575479       1.660907       1.464458</span></span>
<span><span class="co">#&gt; 5:       1.856263       2.011461       1.584364       1.620161       1.452185</span></span>
<span><span class="co">#&gt; 6:       1.863853       2.029706       1.573575       1.635628       1.476124</span></span>
<span><span class="co">#&gt;    Marker_6_asinh Marker_7_asinh Marker_8_asinh Marker_9_asinh Marker_10_asinh</span></span>
<span><span class="co">#&gt; 1:       1.828949       1.540053       2.055089       1.439701        1.888460</span></span>
<span><span class="co">#&gt; 2:       1.823853       1.591077       2.072301       1.271905        1.874298</span></span>
<span><span class="co">#&gt; 3:       1.833658       1.493302       2.040148       1.406397        1.895299</span></span>
<span><span class="co">#&gt; 4:       1.847964       1.444526       2.063727       1.446265        1.897996</span></span>
<span><span class="co">#&gt; 5:       1.830753       1.425306       2.050317       1.366122        1.891174</span></span>
<span><span class="co">#&gt; 6:       1.821135       1.494759       2.059819       1.291531        1.888000</span></span>
<span><span class="co">#&gt;    Marker_11_asinh Marker_12_asinh Marker_13_asinh Marker_14_asinh</span></span>
<span><span class="co">#&gt; 1:       0.9158926        1.323767       1.1556913        1.317133</span></span>
<span><span class="co">#&gt; 2:       1.0480850        1.350889       0.8390653        1.205700</span></span>
<span><span class="co">#&gt; 3:       1.0528720        1.267242       0.9939983        1.169445</span></span>
<span><span class="co">#&gt; 4:       0.6963542        1.324948       0.8055108        1.270159</span></span>
<span><span class="co">#&gt; 5:       0.8634084        1.217000       1.0119470        1.197132</span></span>
<span><span class="co">#&gt; 6:       1.0332129        1.332130       0.9939185        1.282483</span></span>
<span><span class="co">#&gt;    Marker_15_asinh   Sample                 SuperCellId</span></span>
<span><span class="co">#&gt; 1:        1.642352 Sample_1 SuperCell_1_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 2:        1.662549 Sample_1 SuperCell_2_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 3:        1.518770 Sample_1 SuperCell_3_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 4:        1.655260 Sample_1 SuperCell_4_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 5:        1.612056 Sample_1 SuperCell_5_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 6:        1.631646 Sample_1 SuperCell_6_Sample_Sample_1</span></span></code></pre></div>
<p>Therein, we will have the following columns:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">$</span><span class="va">supercell_expression_matrix</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "Marker_1_asinh"  "Marker_2_asinh"  "Marker_3_asinh"  "Marker_4_asinh" </span></span>
<span><span class="co">#&gt;  [5] "Marker_5_asinh"  "Marker_6_asinh"  "Marker_7_asinh"  "Marker_8_asinh" </span></span>
<span><span class="co">#&gt;  [9] "Marker_9_asinh"  "Marker_10_asinh" "Marker_11_asinh" "Marker_12_asinh"</span></span>
<span><span class="co">#&gt; [13] "Marker_13_asinh" "Marker_14_asinh" "Marker_15_asinh" "Sample"         </span></span>
<span><span class="co">#&gt; [17] "SuperCellId"</span></span></code></pre></div>
<ol style="list-style-type: decimal">
<li>All the markers we previously specified in the
<code>markers_col</code> variable.</li>
<li>A column (<code>Sample</code> in this case) denoting which sample a
supercell belongs to, (note the column name is the same as what is
stored in <code>sample_col</code> variable).</li>
<li>The <code>SuperCellId</code> column denoting the unique ID of the
supercell.</li>
</ol>
<div class="section level4">
<h4 id="supercellid">SuperCellId<a class="anchor" aria-label="anchor" href="#supercellid"></a>
</h4>
<p>Let’s have a look at <code>SuperCellId</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">$</span><span class="va">supercell_expression_matrix</span><span class="op">$</span><span class="va">SuperCellId</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "SuperCell_1_Sample_Sample_1" "SuperCell_2_Sample_Sample_1"</span></span>
<span><span class="co">#&gt; [3] "SuperCell_3_Sample_Sample_1" "SuperCell_4_Sample_Sample_1"</span></span>
<span><span class="co">#&gt; [5] "SuperCell_5_Sample_Sample_1" "SuperCell_6_Sample_Sample_1"</span></span></code></pre></div>
<p>Let’s break down one of them,
<code>SuperCell_1_Sample_Sample_1</code>. <code>SuperCell_1</code> is a
numbering (1 to however many supercells there are in a sample) used to
uniquely identify each supercell in a sample. Notably, you may encounter
this (<code>SuperCell_1</code>, <code>SuperCell_2</code>) being repeated
across different samples, e.g.,</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">supercell_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">$</span><span class="va">supercell_expression_matrix</span><span class="op">$</span><span class="va">SuperCellId</span><span class="op">)</span></span>
<span><span class="va">supercell_ids</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"SuperCell_1_"</span>, <span class="va">supercell_ids</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "SuperCell_1_Sample_Sample_1" "SuperCell_1_Sample_Sample_2"</span></span>
<span><span class="co">#&gt; [3] "SuperCell_1_Sample_Sample_3"</span></span></code></pre></div>
<p>While these 3 supercells’ id are pre-fixed with
<code>SuperCell_1</code>, it does not make them equal to one another!
<code>SuperCell_1_Sample_Sample_1</code> will only contain cells from
<code>Sample_1</code> while <code>SuperCell_1_Sample_Sample_2</code>
will only contain cells from <code>Sample_2</code>.</p>
<p>By now, you may have noticed that we appended the sample name into
each supercell id. This aids in differentiating the supercells in
different samples.</p>
</div>
</div>
<div class="section level3">
<h3 id="supercell-cell-map">Supercell cell map<a class="anchor" aria-label="anchor" href="#supercell-cell-map"></a>
</h3>
<p><code>supercell_cell_map</code> maps each cell in our dataset to the
supercell it belongs to.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">$</span><span class="va">supercell_cell_map</span><span class="op">)</span></span>
<span><span class="co">#&gt;                      SuperCellID   Sample</span></span>
<span><span class="co">#&gt; 1: SuperCell_205_Sample_Sample_1 Sample_1</span></span>
<span><span class="co">#&gt; 2:  SuperCell_14_Sample_Sample_1 Sample_1</span></span>
<span><span class="co">#&gt; 3: SuperCell_360_Sample_Sample_1 Sample_1</span></span>
<span><span class="co">#&gt; 4: SuperCell_195_Sample_Sample_1 Sample_1</span></span>
<span><span class="co">#&gt; 5:   SuperCell_7_Sample_Sample_1 Sample_1</span></span>
<span><span class="co">#&gt; 6:  SuperCell_85_Sample_Sample_1 Sample_1</span></span></code></pre></div>
<p>This map is very useful if we later need to expand the supercells
out. Additionally, this is also the reason why we need to have a column
in the dataset which uniquely identify each cell.</p>
</div>
</div>
<div class="section level2">
<h2 id="running-runsupercellcyto-in-parallel">Running <code>runSuperCellCyto</code> in parallel<a class="anchor" aria-label="anchor" href="#running-runsupercellcyto-in-parallel"></a>
</h2>
<p>By default, <code>runSuperCellCyto</code> will process each sample
one after the other. As each sample is processed independent of one
another, we can process all of them in parallel.</p>
<p>To do this, we need to create a <code>BiocParallelParam</code> object
that leverages parallel processing. Additionally, we will also set the
number of tasks to the number of samples, and set the
<code>load_balancing</code> parameter to TRUE so jobs that are
supercelling large samples are not assigned small samples (they will
instead be given to those that are supercelling smaller samples).</p>
<p>Notably, we should not set more workers than the total number of
cores we have in the computer, as it will render your computer useless
for anything else (and it might blow out your RAM). To find out the
total number of cores we have in the computer, we can use parallel’s
detectCores.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_cores</span> <span class="op">&lt;-</span> <span class="fu">detectCores</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">supercell_par</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSuperCellCyto.html">runSuperCellCyto</a></span><span class="op">(</span></span>
<span>  dt <span class="op">=</span> <span class="va">dat</span>,</span>
<span>  markers <span class="op">=</span> <span class="va">markers_col</span>,</span>
<span>  sample_colname <span class="op">=</span> <span class="va">sample_col</span>,</span>
<span>  cell_id_colname <span class="op">=</span> <span class="va">cell_id_col</span>,</span>
<span>  BPPARAM <span class="op">=</span> <span class="fu">MulticoreParam</span><span class="op">(</span></span>
<span>    workers <span class="op">=</span> <span class="va">n_cores</span> <span class="op">-</span> <span class="fl">1</span>,</span>
<span>    tasks <span class="op">=</span> <span class="va">n_samples</span></span>
<span>  <span class="op">)</span>,</span>
<span>  load_balancing <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="controlling-the-supercells-granularity">Controlling the supercells’ granularity<a class="anchor" aria-label="anchor" href="#controlling-the-supercells-granularity"></a>
</h2>
<p>This is described in the <code>runSuperCellCyto</code> function’s
documentation, but let’s briefly go through it here.</p>
<p>The <code>runSuperCellCyto</code> function is equipped with various
parameters which can be customise to alter the composition of the
supercells. The one is very likely to be used the most is the
<code>gam</code> parameter.</p>
<p>The <code>gam</code> parameter controls how many supercells to
generate, and indirectly, how many cells are captured within each
supercell. This parameter is resolved into the following formula
<code>gam=n_cells/n_supercells</code> where <code>n_cell</code> denotes
the number of cells and <code>n_supercells</code> denotes the number of
supercells.</p>
<p>In general, the larger <code>gam</code> parameter is set to, the less
supercells we will get. Say for instance we have 10,000 cells. If
<code>gam</code> is set to 10, we will end up with about 1,000
supercells, whereas if <code>gam</code> is set to 50, we will end up
with about 200 supercells.</p>
<p>You may have noticed, after reading the sections above,
<code>runSuperCellCyto</code> is ran on each sample independent of each
other, and that we can only set 1 value as the <code>gam</code>
parameter. Indeed, for now, the same <code>gam</code> value will be used
across all samples, and that depending on how many cells we have in each
sample, we will end up with different number of supercells for each
sample. For instance, say we have 10,000 cells for sample 1, and 100,000
cells for sample 2. If <code>gam</code> is set to 10, for sample 1, we
will get 1,000 supercells (10,000/10) while for sample 2, we will get
10,000 supercells (100,000/10).</p>
<p>In the future, we may add the ability to specify different
<code>gam</code> value for different samples. For now, if we want to do
this, we will need to break down our data into multiple
<code>data.table</code> objects, each containing data from 1 sample, and
run <code>runSuperCellCyto</code> function on each of them with
different <code>gam</code> parameter value. Something like the
following:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_markers</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simCytoData.html">simCytoData</a></span><span class="op">(</span>nmarkers <span class="op">=</span> <span class="va">n_markers</span><span class="op">)</span></span>
<span><span class="va">markers_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Marker_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_markers</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sample_col</span> <span class="op">&lt;-</span> <span class="st">"Sample"</span></span>
<span><span class="va">cell_id_col</span> <span class="op">&lt;-</span> <span class="st">"Cell_Id"</span></span>
<span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[[</span><span class="va">sample_col</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">gam_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">supercells_diff_gam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sample</span> <span class="op">&lt;-</span> <span class="va">samples</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">gam</span> <span class="op">&lt;-</span> <span class="va">gam_values</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">dat_samp</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">[</span><span class="va">dat</span><span class="op">$</span><span class="va">Sample</span> <span class="op">==</span> <span class="va">sample</span>, <span class="op">]</span></span>
<span>  <span class="va">supercell_samp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSuperCellCyto.html">runSuperCellCyto</a></span><span class="op">(</span></span>
<span>    dt <span class="op">=</span> <span class="va">dat_samp</span>,</span>
<span>    markers <span class="op">=</span> <span class="va">markers_col</span>,</span>
<span>    sample_colname <span class="op">=</span> <span class="va">sample_col</span>,</span>
<span>    cell_id_colname <span class="op">=</span> <span class="va">cell_id_col</span>,</span>
<span>    gam <span class="op">=</span> <span class="va">gam</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">supercell_samp</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Subsequently, to extract and combine the
<code>supercell_expression_matrix</code> and
<code>supercell_cell_map</code>, we will need to use
<code>rbind</code>:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">supercell_expression_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span></span>
<span>  <span class="st">"rbind"</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">supercells_diff_gam</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[[</span><span class="st">"supercell_expression_matrix"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">supercell_cell_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span></span>
<span>  <span class="st">"rbind"</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">supercells_diff_gam</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[[</span><span class="st">"supercell_cell_map"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">supercell_expression_matrix</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">supercell_expression_matrix</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;     Marker_1 Marker_2  Marker_3 Marker_4  Marker_5  Marker_6  Marker_7</span></span>
<span><span class="co">#&gt; 1: 17.185352 13.79483  7.199611 7.414705 10.872808  7.092108 10.012109</span></span>
<span><span class="co">#&gt; 2: 18.264574 12.94228  7.823381 6.735751  8.869444  9.540956 10.189478</span></span>
<span><span class="co">#&gt; 3: 16.358564 13.13526  6.762167 6.833629  8.817561  8.880342 10.227308</span></span>
<span><span class="co">#&gt; 4:  8.313754 17.55438 14.235448 3.367899  8.578768 20.559210  9.458997</span></span>
<span><span class="co">#&gt; 5:  7.037801 16.67756 15.666086 5.394122  9.370089 18.321914  9.639372</span></span>
<span><span class="co">#&gt; 6:  8.967762 15.16358 13.237511 3.696488  9.264790 17.803695  8.824825</span></span>
<span><span class="co">#&gt;     Marker_8  Marker_9 Marker_10   Sample                   SuperCellId</span></span>
<span><span class="co">#&gt; 1: 21.028606 16.703610 11.262654 Sample_1   SuperCell_1_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 2: 18.759925 16.709683 10.958189 Sample_1   SuperCell_2_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 3: 18.839347 17.541261 11.375325 Sample_1   SuperCell_3_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 4:  5.594657  9.119739 12.127811 Sample_2 SuperCell_498_Sample_Sample_2</span></span>
<span><span class="co">#&gt; 5:  3.862401  8.714946  9.651773 Sample_2 SuperCell_499_Sample_Sample_2</span></span>
<span><span class="co">#&gt; 6:  4.664079 10.308013 12.499662 Sample_2 SuperCell_500_Sample_Sample_2</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">supercell_cell_map</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">supercell_cell_map</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;                      SuperCellID     CellId   Sample</span></span>
<span><span class="co">#&gt; 1: SuperCell_719_Sample_Sample_1     Cell_1 Sample_1</span></span>
<span><span class="co">#&gt; 2:  SuperCell_39_Sample_Sample_1     Cell_2 Sample_1</span></span>
<span><span class="co">#&gt; 3: SuperCell_541_Sample_Sample_1     Cell_3 Sample_1</span></span>
<span><span class="co">#&gt; 4: SuperCell_344_Sample_Sample_2 Cell_19998 Sample_2</span></span>
<span><span class="co">#&gt; 5: SuperCell_186_Sample_Sample_2 Cell_19999 Sample_2</span></span>
<span><span class="co">#&gt; 6: SuperCell_128_Sample_Sample_2 Cell_20000 Sample_2</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="using-runsupercellcyto-for-stratified-summarising">Using <code>runSuperCellCyto</code> for stratified summarising<a class="anchor" aria-label="anchor" href="#using-runsupercellcyto-for-stratified-summarising"></a>
</h2>
<p>As previously mentioned, we can use <code>runSuperCellCyto</code> to
perform stratified summarising, i.e., to summarise (well, meaningfully
sub-sample) each cluster or cell type. To do this, we need to change the
sample column such that it denotes the cell type or the cluster a cell
belongs to.</p>
<p>As an example, let’s first cluster a toy data with k-means:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulate some data</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simCytoData.html">simCytoData</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">markers_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Marker_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cell_id_col</span> <span class="op">&lt;-</span> <span class="st">"Cell_Id"</span></span>
<span></span>
<span><span class="co"># Run kmeans</span></span>
<span><span class="va">clust</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">dat</span><span class="op">[</span>, <span class="va">markers_col</span>, with <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>,</span>
<span>  centers <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">clust_col</span> <span class="op">&lt;-</span> <span class="st">"kmeans_clusters"</span></span>
<span><span class="va">dat</span><span class="op">[[</span><span class="va">clust_col</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"cluster_"</span>, <span class="va">clust</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span></span></code></pre></div>
<p>To perform stratified summarising, we supply the cluster column
(<code>kmeans_clusters</code> in the example above), as
<code>runSuperCellCyto</code>’s <code>sample_colname</code>
parameter.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">supercells</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSuperCellCyto.html">runSuperCellCyto</a></span><span class="op">(</span></span>
<span>  dt <span class="op">=</span> <span class="va">dat</span>,</span>
<span>  markers <span class="op">=</span> <span class="va">markers_col</span>,</span>
<span>  sample_colname <span class="op">=</span> <span class="va">clust_col</span>,</span>
<span>  cell_id_colname <span class="op">=</span> <span class="va">cell_id_col</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now, if we look at the <code>supercell_expression_matrix</code>, each
row (each supercell) will be denoted with the cluster it belongs to, and
<em>not the biological sample it came from</em>:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Inspect the top 3 and bottom 3 of the expression matrix and some columns.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">$</span><span class="va">supercell_expression_matrix</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">$</span><span class="va">supercell_expression_matrix</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"kmeans_clusters"</span>, <span class="st">"SuperCellId"</span>, <span class="st">"Marker_10"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt;    kmeans_clusters                    SuperCellId Marker_10</span></span>
<span><span class="co">#&gt; 1:       cluster_4   SuperCell_1_Sample_cluster_4  14.64662</span></span>
<span><span class="co">#&gt; 2:       cluster_4   SuperCell_2_Sample_cluster_4  14.66858</span></span>
<span><span class="co">#&gt; 3:       cluster_4   SuperCell_3_Sample_cluster_4  14.41837</span></span>
<span><span class="co">#&gt; 4:       cluster_5 SuperCell_498_Sample_cluster_5  16.99003</span></span>
<span><span class="co">#&gt; 5:       cluster_5 SuperCell_499_Sample_cluster_5  17.09864</span></span>
<span><span class="co">#&gt; 6:       cluster_5 SuperCell_500_Sample_cluster_5  15.85447</span></span></code></pre></div>
<p>If we look at the number of supercells created and check how many
cells there were in each cluster, we will find that, for each cluster,
we get approximately <code>n_cells/20</code> where 20 is the
<code>gam</code> parameter value we used for
<code>runSuperCellCyto</code> (this is the default).</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute how many cells per cluster, and divide by 20, the gamma value.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">kmeans_clusters</span><span class="op">)</span> <span class="op">/</span> <span class="fl">20</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; cluster_1 cluster_2 cluster_3 cluster_4 cluster_5 </span></span>
<span><span class="co">#&gt;    120.25    130.30    119.75    129.70    500.00</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">$</span><span class="va">supercell_expression_matrix</span><span class="op">$</span><span class="va">kmeans_clusters</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; cluster_1 cluster_2 cluster_3 cluster_4 cluster_5 </span></span>
<span><span class="co">#&gt;       120       130       120       130       500</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; R version 4.3.2 (2023-10-31)</span></span>
<span><span class="co">#&gt; Platform: x86_64-pc-linux-gnu (64-bit)</span></span>
<span><span class="co">#&gt; Running under: Ubuntu 22.04.3 LTS</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so;  LAPACK version 3.10.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt;  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">#&gt;  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">#&gt;  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">#&gt; [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: UTC</span></span>
<span><span class="co">#&gt; tzcode source: system (glibc)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] parallel  stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">#&gt; [8] base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt; [1] BiocParallel_1.36.0 SuperCellCyto_0.1.0 BiocStyle_2.30.0   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;  [1] Matrix_1.6-1.1      jsonlite_1.8.8      compiler_4.3.2     </span></span>
<span><span class="co">#&gt;  [4] BiocManager_1.30.22 Rcpp_1.0.12         stringr_1.5.1      </span></span>
<span><span class="co">#&gt;  [7] SuperCell_1.0       jquerylib_0.1.4     systemfonts_1.0.5  </span></span>
<span><span class="co">#&gt; [10] textshaping_0.3.7   yaml_2.3.8          fastmap_1.1.1      </span></span>
<span><span class="co">#&gt; [13] lattice_0.21-9      plyr_1.8.9          R6_2.5.1           </span></span>
<span><span class="co">#&gt; [16] igraph_1.6.0        knitr_1.45          bookdown_0.37      </span></span>
<span><span class="co">#&gt; [19] desc_1.4.3          bslib_0.6.1         rlang_1.1.3        </span></span>
<span><span class="co">#&gt; [22] cachem_1.0.8        stringi_1.8.3       RANN_2.6.1         </span></span>
<span><span class="co">#&gt; [25] xfun_0.41           fs_1.6.3            sass_0.4.8         </span></span>
<span><span class="co">#&gt; [28] memoise_2.0.1       cli_3.6.2           pkgdown_2.0.7      </span></span>
<span><span class="co">#&gt; [31] magrittr_2.0.3      digest_0.6.34       grid_4.3.2         </span></span>
<span><span class="co">#&gt; [34] lifecycle_1.0.4     vctrs_0.6.5         evaluate_0.23      </span></span>
<span><span class="co">#&gt; [37] glue_1.7.0          data.table_1.14.10  codetools_0.2-19   </span></span>
<span><span class="co">#&gt; [40] ragg_1.2.7          rmarkdown_2.25      purrr_1.0.2        </span></span>
<span><span class="co">#&gt; [43] pkgconfig_2.0.3     tools_4.3.2         htmltools_0.5.7</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Givanna Putri, George Howitt, Felix Marsh-Wakefield, Thomas Ashhurst, Belinda Phipson.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
