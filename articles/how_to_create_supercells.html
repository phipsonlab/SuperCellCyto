<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="SuperCellCyto">
<title>How to create supercells • SuperCellCyto</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="How to create supercells">
<meta property="og:description" content="SuperCellCyto">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">SuperCellCyto</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/how_to_create_supercells.html">How to create supercells</a>
    <a class="dropdown-item" href="../articles/how_to_prepare_data.html">How to Prepare Data for SuperCellCyto</a>
    <a class="dropdown-item" href="../articles/interoperability_with_sce.html">Interoperability with SingleCellExperiment</a>
    <a class="dropdown-item" href="../articles/interoperability_with_seurat.html">Interoperability with Seurat</a>
    <a class="dropdown-item" href="../articles/using_supercellcyto_for_stratified_summarising.html">Using SuperCellCyto for Stratified Summarising</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>How to create supercells</h1>
                        <h4 data-toc-skip class="author">Givanna
Putri</h4>
            
      
      
      <div class="d-none name"><code>how_to_create_supercells.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette describes the steps to generate supercells for
cytometry data using SuperCellCyto R package.</p>
<p>Please note that we’re still actively updating this vignette (and in
fact the package itself), and that we welcome any feedbacks on how to
improve them. Please reach out by creating GitHub issues on our GitHub
repository.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>SuperCellCyto can be installed using the <code>remotes</code> package
from CRAN:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install remotes package first.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span></span>
<span><span class="co"># then use it to install SuperCellCyto</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"phipsonlab/SuperCellCyto"</span><span class="op">)</span></span></code></pre></div>
<p>SuperCellCyto requires the <a href="https://github.com/GfellerLab/SuperCell" class="external-link">SuperCell R package</a>
installed to run properly. If you use the
<code><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">remotes::install_github</a></code> command above to install
SuperCellCyto, it should be automatically installed. But in the case it
doesn’t, you can manually install it by using:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"GfellerLab/SuperCell"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="preparing-your-dataset">Preparing your dataset<a class="anchor" aria-label="anchor" href="#preparing-your-dataset"></a>
</h2>
<p>The function which creates supercells is called
<code>runSuperCellCyto</code>, and it operates on a
<code>data.table</code> object, an enhanced version of R native
<code>data.frame</code>.</p>
<p>In addition to needing the data stored in a <code>data.table</code>
object it also requires:</p>
<ol style="list-style-type: decimal">
<li>The markers you will be using to create supercells to have been
appropriately transformed, typically using either arcsinh transformation
or linear binning (using FlowJo). <strong><code>runSuperCellCyto</code>
does not perform any data transformation or scaling.</strong>
</li>
<li>The object to have a column denoting the unique ID of each cell. You
most likely have to create this column yourself, and it can simply just
be a numerical value ranging from 1 to however many cells you have in
your data.</li>
<li>The object to have a column denoting the biological sample each cell
comes from. This column is critical to ensure that cells from different
samples will not be mixed in a supercell.</li>
</ol>
<p>If you are not sure how to import CSV or FCS files into
<code>data.table</code> object, and/or how to subsequently prepare the
object ready for SuperCellCyto, please consult this <a href="how_to_prepare_data.html">vignette</a>. In that vignette, we also
provide an explanation behind why we need to have the cell ID and sample
column.</p>
<p>For this vignette, we will simulate some toy data using the
<code>simCytoData</code> function. Specifically, we will simulate 15
markers and 3 samples, with each sample containing 10,000 cells. Hence
in total, we will have a toy dataset containing 15 markers and 30,000
cells.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_markers</span> <span class="op">&lt;-</span> <span class="fl">15</span></span>
<span><span class="va">n_samples</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simCytoData.html">simCytoData</a></span><span class="op">(</span>nmarkers <span class="op">=</span> <span class="va">n_markers</span>, ncells <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">10000</span>, <span class="va">n_samples</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Marker_1 Marker_2 Marker_3 Marker_4  Marker_5 Marker_6 Marker_7  Marker_8</span></span>
<span><span class="co">#&gt;       &lt;num&gt;    &lt;num&gt;    &lt;num&gt;    &lt;num&gt;     &lt;num&gt;    &lt;num&gt;    &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: 14.78508 11.46732 16.02882 14.53514 11.361341 17.27196 14.95258 11.559225</span></span>
<span><span class="co">#&gt; 2: 13.38608 10.00490 16.38800 14.26676  9.676632 16.17511 13.30027  9.773430</span></span>
<span><span class="co">#&gt; 3: 13.30389 10.22871 15.93686 13.75954 11.347883 14.60609 11.38706 10.365720</span></span>
<span><span class="co">#&gt; 4: 12.89424 11.04527 14.38678 14.20149  9.823518 13.93631 13.76909  8.663292</span></span>
<span><span class="co">#&gt; 5: 11.33898 11.99155 15.28188 15.45479 11.201314 15.19286 15.10400 10.664897</span></span>
<span><span class="co">#&gt; 6: 12.90466 10.32318 16.61713 14.11982 10.401083 15.85548 15.45114 10.352499</span></span>
<span><span class="co">#&gt;    Marker_9 Marker_10 Marker_11 Marker_12 Marker_13 Marker_14 Marker_15</span></span>
<span><span class="co">#&gt;       &lt;num&gt;     &lt;num&gt;     &lt;num&gt;     &lt;num&gt;     &lt;num&gt;     &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: 14.72981  6.979368  15.86976  14.95921  11.93508  10.22695  12.27246</span></span>
<span><span class="co">#&gt; 2: 15.59030  6.319547  17.27092  13.01232  11.51998  12.85032  11.29259</span></span>
<span><span class="co">#&gt; 3: 14.49481  6.027860  15.66629  12.04383  11.36896  11.05900  11.29240</span></span>
<span><span class="co">#&gt; 4: 15.01743  4.892321  17.30672  12.77711  11.18833  12.59969  12.79109</span></span>
<span><span class="co">#&gt; 5: 14.73888  8.552369  16.81257  13.41666  11.40646  12.62515  11.74756</span></span>
<span><span class="co">#&gt; 6: 15.93691  4.653998  16.24677  13.14396  12.04830  12.29714  10.93690</span></span>
<span><span class="co">#&gt;      Sample Cell_Id</span></span>
<span><span class="co">#&gt;      &lt;char&gt;  &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: Sample_1  Cell_1</span></span>
<span><span class="co">#&gt; 2: Sample_1  Cell_2</span></span>
<span><span class="co">#&gt; 3: Sample_1  Cell_3</span></span>
<span><span class="co">#&gt; 4: Sample_1  Cell_4</span></span>
<span><span class="co">#&gt; 5: Sample_1  Cell_5</span></span>
<span><span class="co">#&gt; 6: Sample_1  Cell_6</span></span></code></pre></div>
<p>For our toy dataset, we will transform our data using arcsinh
transformation. We will use the base R <code>asinh</code> function to do
this:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Specify which columns are the markers to transform</span></span>
<span><span class="va">marker_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Marker_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_markers</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># The co-factor for arc-sinh</span></span>
<span><span class="va">cofactor</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span></span>
<span><span class="co"># Do the transformation</span></span>
<span><span class="va">dat_asinh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Hyperbolic.html" class="external-link">asinh</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[</span>, <span class="va">marker_cols</span>, with <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span> <span class="op">/</span> <span class="va">cofactor</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rename the new columns</span></span>
<span><span class="va">marker_cols_asinh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">marker_cols</span>, <span class="st">"_asinh"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat_asinh</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">marker_cols_asinh</span></span>
<span></span>
<span><span class="co"># Add them our previously loaded data</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">dat_asinh</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[</span>, <span class="va">marker_cols_asinh</span>, with <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Marker_1_asinh Marker_2_asinh Marker_3_asinh Marker_4_asinh Marker_5_asinh</span></span>
<span><span class="co">#&gt;             &lt;num&gt;          &lt;num&gt;          &lt;num&gt;          &lt;num&gt;          &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:       1.804766       1.567669       1.881582       1.788629       1.559165</span></span>
<span><span class="co">#&gt; 2:       1.711109       1.444073       1.902757       1.771023       1.414333</span></span>
<span><span class="co">#&gt; 3:       1.705342       1.463907       1.876090       1.736929       1.558080</span></span>
<span><span class="co">#&gt; 4:       1.676123       1.533401       1.778932       1.766697       1.427738</span></span>
<span><span class="co">#&gt; 5:       1.557362       1.608787       1.836125       1.846824       1.546196</span></span>
<span><span class="co">#&gt; 6:       1.676876       1.472173       1.916045       1.761259       1.478945</span></span>
<span><span class="co">#&gt;    Marker_6_asinh Marker_7_asinh Marker_8_asinh Marker_9_asinh Marker_10_asinh</span></span>
<span><span class="co">#&gt;             &lt;num&gt;          &lt;num&gt;          &lt;num&gt;          &lt;num&gt;           &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:       1.953115       1.815443       1.574991       1.801218       1.1355813</span></span>
<span><span class="co">#&gt; 2:       1.890258       1.705087       1.423185       1.855133       1.0562528</span></span>
<span><span class="co">#&gt; 3:       1.793234       1.561234       1.475876       1.786002       1.0195354</span></span>
<span><span class="co">#&gt; 4:       1.748936       1.737582       1.317262       1.819548       0.8660632</span></span>
<span><span class="co">#&gt; 5:       1.830574       1.825004       1.501572       1.801801       1.3061188</span></span>
<span><span class="co">#&gt; 6:       1.871207       1.846599       1.474727       1.876093       0.8315855</span></span>
<span><span class="co">#&gt;    Marker_11_asinh Marker_12_asinh Marker_13_asinh Marker_14_asinh</span></span>
<span><span class="co">#&gt;              &lt;num&gt;           &lt;num&gt;           &lt;num&gt;           &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:        1.872065        1.815863        1.604432        1.463753</span></span>
<span><span class="co">#&gt; 2:        1.953057        1.684627        1.571870        1.672942</span></span>
<span><span class="co">#&gt; 3:        1.859765        1.612804        1.559779        1.534532</span></span>
<span><span class="co">#&gt; 4:        1.955046        1.667620        1.545137        1.654611</span></span>
<span><span class="co">#&gt; 5:        1.927248        1.713247        1.562793        1.656487</span></span>
<span><span class="co">#&gt; 6:        1.894482        1.694029        1.613147        1.632057</span></span>
<span><span class="co">#&gt;    Marker_15_asinh</span></span>
<span><span class="co">#&gt;              &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:        1.630196</span></span>
<span><span class="co">#&gt; 2:        1.553612</span></span>
<span><span class="co">#&gt; 3:        1.553596</span></span>
<span><span class="co">#&gt; 4:        1.668639</span></span>
<span><span class="co">#&gt; 5:        1.589844</span></span>
<span><span class="co">#&gt; 6:        1.524426</span></span></code></pre></div>
<p>We will also create a column <em>Cell_id_dummy</em> which uniquely
identify each cell. It will have values such as
<code>Cell_1, Cell_2,</code> all the way until <code>Cell_x</code> where
x is the number of cells in the dataset.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span><span class="op">$</span><span class="va">Cell_id_dummy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Cell_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">Cell_id_dummy</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "Cell_1"  "Cell_2"  "Cell_3"  "Cell_4"  "Cell_5"  "Cell_6"  "Cell_7" </span></span>
<span><span class="co">#&gt;  [8] "Cell_8"  "Cell_9"  "Cell_10"</span></span></code></pre></div>
<p>By default, the <code>simCytoData</code> function will generate cells
for multiple samples, and that the resulting <code>data.table</code>
object will already have a column called <em>Sample</em> that denotes
the sample the cells come from.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">Sample</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Sample_1" "Sample_2" "Sample_3"</span></span></code></pre></div>
<p>Let’s take note of the sample and cell id column for later.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sample_col</span> <span class="op">&lt;-</span> <span class="st">"Sample"</span></span>
<span><span class="va">cell_id_col</span> <span class="op">&lt;-</span> <span class="st">"Cell_id_dummy"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="creating-supercells">Creating supercells<a class="anchor" aria-label="anchor" href="#creating-supercells"></a>
</h2>
<p>Now that we have our data, let’s create some supercells. To do this,
we will use <code>runSuperCellCyto</code> function and pass the markers,
sample and cell ID columns as parameters.</p>
<p>The reason why we need to specify the markers is because the function
will create supercells based on only the expression of those markers. We
highly recommend creating supercells using all markers in your data, let
that be cell type or cell state markers. However, if for any reason you
only want to only use a subset of the markers in your data, then make
sure you specify them in a vector that you later pass to
<code>runSuperCellCyto</code> function.</p>
<p>For this tutorial, we will use all the arcsinh transformed markers in
the toy data.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">supercells</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSuperCellCyto.html">runSuperCellCyto</a></span><span class="op">(</span></span>
<span>  dt <span class="op">=</span> <span class="va">dat</span>,</span>
<span>  markers <span class="op">=</span> <span class="va">marker_cols_asinh</span>,</span>
<span>  sample_colname <span class="op">=</span> <span class="va">sample_col</span>,</span>
<span>  cell_id_colname <span class="op">=</span> <span class="va">cell_id_col</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Let’s dig deeper into the object it created:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "list"</span></span></code></pre></div>
<p>It is a list containing 3 elements:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "supercell_expression_matrix" "supercell_cell_map"         </span></span>
<span><span class="co">#&gt; [3] "supercell_object"</span></span></code></pre></div>
<div class="section level3">
<h3 id="supercell-object">Supercell object<a class="anchor" aria-label="anchor" href="#supercell-object"></a>
</h3>
<p>The <code>supercell_object</code> contains the metadata used to
create the supercells. It is a list, and each element contains the
metadata used to create the supercells for a sample. This will come in
handy if we need to either regenerate the supercells using different
gamma values (so we get more or less supercells) or do some debugging
later down the line. More on regenerating supercells on <a href="#controlling-supercells-granularity">Controlling supercells
granularity</a> section below.</p>
</div>
<div class="section level3">
<h3 id="supercell-expression-matrix">Supercell expression matrix<a class="anchor" aria-label="anchor" href="#supercell-expression-matrix"></a>
</h3>
<p>The <code>supercell_expression_matrix</code> contains the marker
expression of each supercell. These are calculated by taking the average
of the marker expression of all the cells contained within a
supercell.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">$</span><span class="va">supercell_expression_matrix</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Marker_1_asinh Marker_2_asinh Marker_3_asinh Marker_4_asinh Marker_5_asinh</span></span>
<span><span class="co">#&gt;             &lt;num&gt;          &lt;num&gt;          &lt;num&gt;          &lt;num&gt;          &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:       1.691329       1.550606       1.898132       1.780710       1.487856</span></span>
<span><span class="co">#&gt; 2:       1.695916       1.498987       1.913532       1.758486       1.463711</span></span>
<span><span class="co">#&gt; 3:       1.749188       1.531319       1.904734       1.736542       1.487504</span></span>
<span><span class="co">#&gt; 4:       1.695944       1.457310       1.923088       1.783407       1.527218</span></span>
<span><span class="co">#&gt; 5:       1.653086       1.459802       1.924634       1.801750       1.447980</span></span>
<span><span class="co">#&gt; 6:       1.704246       1.439907       1.905397       1.780216       1.544557</span></span>
<span><span class="co">#&gt;    Marker_6_asinh Marker_7_asinh Marker_8_asinh Marker_9_asinh Marker_10_asinh</span></span>
<span><span class="co">#&gt;             &lt;num&gt;          &lt;num&gt;          &lt;num&gt;          &lt;num&gt;           &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:       1.819299       1.734818       1.494187       1.779926       0.9840242</span></span>
<span><span class="co">#&gt; 2:       1.850602       1.746769       1.429866       1.822593       1.1290194</span></span>
<span><span class="co">#&gt; 3:       1.824013       1.711258       1.556914       1.829222       1.1645008</span></span>
<span><span class="co">#&gt; 4:       1.876448       1.765135       1.577885       1.819322       1.0353702</span></span>
<span><span class="co">#&gt; 5:       1.844546       1.842797       1.512834       1.825587       0.9839473</span></span>
<span><span class="co">#&gt; 6:       1.847441       1.753638       1.459140       1.814697       0.9726030</span></span>
<span><span class="co">#&gt;    Marker_11_asinh Marker_12_asinh Marker_13_asinh Marker_14_asinh</span></span>
<span><span class="co">#&gt;              &lt;num&gt;           &lt;num&gt;           &lt;num&gt;           &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:        1.852364        1.574876        1.600453        1.686790</span></span>
<span><span class="co">#&gt; 2:        1.874471        1.655252        1.540188        1.606266</span></span>
<span><span class="co">#&gt; 3:        1.876737        1.767231        1.544075        1.661962</span></span>
<span><span class="co">#&gt; 4:        1.886501        1.634392        1.603973        1.592454</span></span>
<span><span class="co">#&gt; 5:        1.892009        1.597766        1.586930        1.610250</span></span>
<span><span class="co">#&gt; 6:        1.884302        1.681828        1.509990        1.592175</span></span>
<span><span class="co">#&gt;    Marker_15_asinh   Sample                 SuperCellId</span></span>
<span><span class="co">#&gt;              &lt;num&gt;   &lt;char&gt;                      &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:        1.588704 Sample_1 SuperCell_1_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 2:        1.588338 Sample_1 SuperCell_2_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 3:        1.552266 Sample_1 SuperCell_3_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 4:        1.582996 Sample_1 SuperCell_4_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 5:        1.552299 Sample_1 SuperCell_5_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 6:        1.598380 Sample_1 SuperCell_6_Sample_Sample_1</span></span></code></pre></div>
<p>Therein, we will have the following columns:</p>
<ol style="list-style-type: decimal">
<li>All the markers we previously specified in the
<code>markers_col</code> variable. In this example, they are the arcsinh
transformed markers in our toy data.</li>
<li>A column (<code>Sample</code> in this case) denoting which sample a
supercell belongs to, (note the column name is the same as what is
stored in <code>sample_col</code> variable).</li>
<li>The <code>SuperCellId</code> column denoting the unique ID of the
supercell.</li>
</ol>
<div class="section level4">
<h4 id="supercellid">SuperCellId<a class="anchor" aria-label="anchor" href="#supercellid"></a>
</h4>
<p>Let’s have a look at <code>SuperCellId</code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">$</span><span class="va">supercell_expression_matrix</span><span class="op">$</span><span class="va">SuperCellId</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "SuperCell_1_Sample_Sample_1" "SuperCell_2_Sample_Sample_1"</span></span>
<span><span class="co">#&gt; [3] "SuperCell_3_Sample_Sample_1" "SuperCell_4_Sample_Sample_1"</span></span>
<span><span class="co">#&gt; [5] "SuperCell_5_Sample_Sample_1" "SuperCell_6_Sample_Sample_1"</span></span></code></pre></div>
<p>Let’s break down one of them,
<code>SuperCell_1_Sample_Sample_1</code>. <code>SuperCell_1</code> is a
numbering (1 to however many supercells there are in a sample) used to
uniquely identify each supercell in a sample. Notably, you may encounter
this (<code>SuperCell_1</code>, <code>SuperCell_2</code>) being repeated
across different samples, e.g.,</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">supercell_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">$</span><span class="va">supercell_expression_matrix</span><span class="op">$</span><span class="va">SuperCellId</span><span class="op">)</span></span>
<span><span class="va">supercell_ids</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"SuperCell_1_"</span>, <span class="va">supercell_ids</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "SuperCell_1_Sample_Sample_1" "SuperCell_1_Sample_Sample_2"</span></span>
<span><span class="co">#&gt; [3] "SuperCell_1_Sample_Sample_3"</span></span></code></pre></div>
<p>While these 3 supercells’ id are pre-fixed with
<code>SuperCell_1</code>, it does not make them equal to one another!
<code>SuperCell_1_Sample_Sample_1</code> will only contain cells from
<code>Sample_1</code> while <code>SuperCell_1_Sample_Sample_2</code>
will only contain cells from <code>Sample_2</code>.</p>
<p>By now, you may have noticed that we appended the sample name into
each supercell id. This aids in differentiating the supercells in
different samples.</p>
</div>
</div>
<div class="section level3">
<h3 id="supercell-cell-map">Supercell cell map<a class="anchor" aria-label="anchor" href="#supercell-cell-map"></a>
</h3>
<p><code>supercell_cell_map</code> maps each cell in our dataset to the
supercell it belongs to.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">$</span><span class="va">supercell_cell_map</span><span class="op">)</span></span>
<span><span class="co">#&gt;                      SuperCellID CellId   Sample</span></span>
<span><span class="co">#&gt;                           &lt;char&gt; &lt;char&gt;   &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:  SuperCell_38_Sample_Sample_1 Cell_1 Sample_1</span></span>
<span><span class="co">#&gt; 2:   SuperCell_2_Sample_Sample_1 Cell_2 Sample_1</span></span>
<span><span class="co">#&gt; 3:  SuperCell_51_Sample_Sample_1 Cell_3 Sample_1</span></span>
<span><span class="co">#&gt; 4: SuperCell_252_Sample_Sample_1 Cell_4 Sample_1</span></span>
<span><span class="co">#&gt; 5: SuperCell_322_Sample_Sample_1 Cell_5 Sample_1</span></span>
<span><span class="co">#&gt; 6:  SuperCell_37_Sample_Sample_1 Cell_6 Sample_1</span></span></code></pre></div>
<p>This map is very useful if we later need to expand the supercells
out. Additionally, this is also the reason why we need to have a column
in the dataset which uniquely identify each cell.</p>
</div>
</div>
<div class="section level2">
<h2 id="running-runsupercellcyto-in-parallel">Running <code>runSuperCellCyto</code> in parallel<a class="anchor" aria-label="anchor" href="#running-runsupercellcyto-in-parallel"></a>
</h2>
<p>By default, <code>runSuperCellCyto</code> will process each sample
one after the other. As each sample is processed independent of one
another, strictly speaking, we can process all of them in parallel.</p>
<p>To do this, we need to:</p>
<ol style="list-style-type: decimal">
<li>Create a <code>BiocParallelParam</code> object from the <a href="https://bioconductor.org/packages/release/bioc/html/BiocParallel.html" class="external-link">BiocParallel</a>
package. This object can either be of type <code>MulticoreParam</code>or
<code>SnowParam</code>. We highly recommend consulting their vignette
for more information.</li>
<li>Set the number of tasks for the <code>BiocParallelParam</code>
object to the number of samples we have in the dataset.</li>
<li>Set the <code>load_balancing</code> parameter for
<code>runSuperCellCyto</code> function to TRUE. This is to ensure even
distribution of the supercell creation jobs. As each sample will be
processed by a parallel job, we don’t want a job that process large
sample to also be assigned other smaller samples if possible. If you
want to know more how this feature works, please refer to our
manuscript.</li>
</ol>
<p><strong>NOTE</strong>: we should not set the value for
<code>workers</code> param for <code>BiocParallelParam</code> object
more than the total number of cores we have in the computer, as it will
render the computer useless for anything else. Perhaps more importantly,
it might blow out your RAM and kill the Rsession. To find out the total
number of cores we have in the computer, we can use parallel’s
<code>detectCores</code> function.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_cores</span> <span class="op">&lt;-</span> <span class="fu">detectCores</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>And supply that number minus one as the <code>workers</code> param
for <code>BiocParallelParam</code> object.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">supercell_par</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSuperCellCyto.html">runSuperCellCyto</a></span><span class="op">(</span></span>
<span>  dt <span class="op">=</span> <span class="va">dat</span>,</span>
<span>  markers <span class="op">=</span> <span class="va">marker_cols_asinh</span>,</span>
<span>  sample_colname <span class="op">=</span> <span class="va">sample_col</span>,</span>
<span>  cell_id_colname <span class="op">=</span> <span class="va">cell_id_col</span>,</span>
<span>  BPPARAM <span class="op">=</span> <span class="fu">MulticoreParam</span><span class="op">(</span></span>
<span>    workers <span class="op">=</span> <span class="va">n_cores</span> <span class="op">-</span> <span class="fl">1</span>,</span>
<span>    tasks <span class="op">=</span> <span class="va">n_samples</span></span>
<span>  <span class="op">)</span>,</span>
<span>  load_balancing <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="controlling-supercells-granularity">Controlling supercells granularity<a class="anchor" aria-label="anchor" href="#controlling-supercells-granularity"></a>
</h2>
<p>This is described in the <code>runSuperCellCyto</code> function’s
documentation, but let’s briefly go through it here.</p>
<p>The <code>runSuperCellCyto</code> function is equipped with various
parameters which can be customised to alter the composition of the
supercells. The one that is very likely to be used the most is the gamma
parameter, denoted as <code>gam</code> in the function. By default, the
value for <code>gam</code> is set to 20, which we found work well for
most cases.</p>
<p>The gamma parameter controls how many supercells to generate, and
indirectly, how many cells are captured within each supercell. This
parameter is resolved into the following formula
<code>gamma=n_cells/n_supercells</code> where <code>n_cell</code>
denotes the number of cells and <code>n_supercells</code> denotes the
number of supercells.</p>
<p>In general, the larger gamma parameter is set to, the less supercells
we will get. Say for instance we have 10,000 cells. If gamma is set to
10, we will end up with about 1,000 supercells, whereas if gamma is set
to 50, we will end up with about 200 supercells.</p>
<p>You may have noticed, after reading the sections above,
<code>runSuperCellCyto</code> is ran on each sample independent of each
other, and that we can only set 1 value as the gamma parameter. Indeed,
for now, the same gamma value will be used across all samples, and that
depending on how many cells we have in each sample, we will end up with
different number of supercells for each sample. For instance, say we
have 10,000 cells for sample 1, and 100,000 cells for sample 2. If gamma
is set to 10, for sample 1, we will get 1,000 supercells (10,000/10)
while for sample 2, we will get 10,000 supercells (100,000/10).</p>
<p><em>Do note</em>: whatever gamma value you chose, you should not
expect each supercell to contain exactly the same number of cells. This
behaviour is intentional to ensure rare cell types are not intermixed
with non-rare cell types in a supercell.</p>
<div class="section level3">
<h3 id="adjusting-gamma-value-after-one-run-of-runsupercellcyto">Adjusting gamma value after one run of runSuperCellCyto<a class="anchor" aria-label="anchor" href="#adjusting-gamma-value-after-one-run-of-runsupercellcyto"></a>
</h3>
<p>If you have run <code>runSuperCellCyto</code> once and have not
discarded the SuperCell object it generated (no serious, please don’t!),
you can use the object to <strong>quickly</strong> regenerate supercells
using different gamma values.</p>
<p>As an example, using the SuperCell object we have generated for our
toy dataset, we will regenerate the supercells using gamma of 10 and 50.
The function to do this is <code>recomputeSupercells</code>. We will
store the output in a list, one element per gamma value.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">addt_gamma_vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">supercells_addt_gamma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">addt_gamma_vals</span>, <span class="kw">function</span><span class="op">(</span><span class="va">gam</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/recomputeSupercells.html">recomputeSupercells</a></span><span class="op">(</span></span>
<span>    dt <span class="op">=</span> <span class="va">dat</span>,</span>
<span>    sc_objects <span class="op">=</span> <span class="va">supercells</span><span class="op">$</span><span class="va">supercell_object</span>,</span>
<span>    markers <span class="op">=</span> <span class="va">marker_cols_asinh</span>,</span>
<span>    sample_colname <span class="op">=</span> <span class="va">sample_col</span>,</span>
<span>    cell_id_colname <span class="op">=</span> <span class="va">cell_id_col</span>,</span>
<span>    gam <span class="op">=</span> <span class="va">gam</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>We should end up with a list containing 2 elements. The 1st element
contains supercells generated using gamma = 10, and the 2nd contains
supercells generated using gamma = 50.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">supercells_addt_gamma</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; $supercell_expression_matrix</span></span>
<span><span class="co">#&gt;       Marker_1_asinh Marker_2_asinh Marker_3_asinh Marker_4_asinh</span></span>
<span><span class="co">#&gt;                &lt;num&gt;          &lt;num&gt;          &lt;num&gt;          &lt;num&gt;</span></span>
<span><span class="co">#&gt;    1:       1.666911      1.4973392       1.938627       1.801758</span></span>
<span><span class="co">#&gt;    2:       1.684959      1.4437751       1.956359       1.833631</span></span>
<span><span class="co">#&gt;    3:       1.623932      1.5709769       1.928599       1.770224</span></span>
<span><span class="co">#&gt;    4:       1.696670      1.5391437       1.904667       1.793493</span></span>
<span><span class="co">#&gt;    5:       1.646421      1.3368148       1.910949       1.777656</span></span>
<span><span class="co">#&gt;   ---                                                            </span></span>
<span><span class="co">#&gt; 2996:       1.953108      1.3479287       1.641390       1.422281</span></span>
<span><span class="co">#&gt; 2997:       1.895679      1.1343138       1.528531       1.347792</span></span>
<span><span class="co">#&gt; 2998:       1.867928      0.8074699       1.638025       1.498555</span></span>
<span><span class="co">#&gt; 2999:       1.921113      0.9458824       1.693556       1.337652</span></span>
<span><span class="co">#&gt; 3000:       1.948728      0.9631695       1.733082       1.406243</span></span>
<span><span class="co">#&gt;       Marker_5_asinh Marker_6_asinh Marker_7_asinh Marker_8_asinh</span></span>
<span><span class="co">#&gt;                &lt;num&gt;          &lt;num&gt;          &lt;num&gt;          &lt;num&gt;</span></span>
<span><span class="co">#&gt;    1:       1.578024      1.8371314       1.767879       1.476111</span></span>
<span><span class="co">#&gt;    2:       1.344421      1.8749591       1.785303       1.440954</span></span>
<span><span class="co">#&gt;    3:       1.576812      1.8578046       1.807564       1.597153</span></span>
<span><span class="co">#&gt;    4:       1.487062      1.8625379       1.755389       1.554041</span></span>
<span><span class="co">#&gt;    5:       1.437434      1.8355352       1.790368       1.527829</span></span>
<span><span class="co">#&gt;   ---                                                            </span></span>
<span><span class="co">#&gt; 2996:       1.656796      0.9521000       1.714532       2.028548</span></span>
<span><span class="co">#&gt; 2997:       1.786094      0.8720232       1.739892       2.047277</span></span>
<span><span class="co">#&gt; 2998:       1.607253      1.1133192       1.754849       2.025359</span></span>
<span><span class="co">#&gt; 2999:       1.719722      0.8666687       1.761836       1.959020</span></span>
<span><span class="co">#&gt; 3000:       1.737869      0.8582768       1.709993       2.001886</span></span>
<span><span class="co">#&gt;       Marker_9_asinh Marker_10_asinh Marker_11_asinh Marker_12_asinh</span></span>
<span><span class="co">#&gt;                &lt;num&gt;           &lt;num&gt;           &lt;num&gt;           &lt;num&gt;</span></span>
<span><span class="co">#&gt;    1:       1.821278       1.1745604        1.875982        1.749784</span></span>
<span><span class="co">#&gt;    2:       1.822783       0.9058521        1.921759        1.714003</span></span>
<span><span class="co">#&gt;    3:       1.793596       1.0325173        1.892032        1.695370</span></span>
<span><span class="co">#&gt;    4:       1.807911       0.8579112        1.872801        1.757490</span></span>
<span><span class="co">#&gt;    5:       1.847556       0.8793861        1.873612        1.751950</span></span>
<span><span class="co">#&gt;   ---                                                               </span></span>
<span><span class="co">#&gt; 2996:       2.135643       1.3968440        1.062031        1.762385</span></span>
<span><span class="co">#&gt; 2997:       2.074888       1.1991391        1.232423        1.738768</span></span>
<span><span class="co">#&gt; 2998:       2.093161       1.0761091        1.303709        1.700323</span></span>
<span><span class="co">#&gt; 2999:       2.096588       1.2591226        1.012375        1.623274</span></span>
<span><span class="co">#&gt; 3000:       2.111757       1.0503182        1.176048        1.772763</span></span>
<span><span class="co">#&gt;       Marker_13_asinh Marker_14_asinh Marker_15_asinh   Sample</span></span>
<span><span class="co">#&gt;                 &lt;num&gt;           &lt;num&gt;           &lt;num&gt;   &lt;char&gt;</span></span>
<span><span class="co">#&gt;    1:        1.564697        1.516341        1.597865 Sample_1</span></span>
<span><span class="co">#&gt;    2:        1.689422        1.676507        1.743651 Sample_1</span></span>
<span><span class="co">#&gt;    3:        1.578082        1.653661        1.595344 Sample_1</span></span>
<span><span class="co">#&gt;    4:        1.556279        1.535982        1.645657 Sample_1</span></span>
<span><span class="co">#&gt;    5:        1.561352        1.600196        1.560640 Sample_1</span></span>
<span><span class="co">#&gt;   ---                                                         </span></span>
<span><span class="co">#&gt; 2996:        1.758900        1.371754        1.948064 Sample_3</span></span>
<span><span class="co">#&gt; 2997:        1.799534        1.463314        1.902415 Sample_3</span></span>
<span><span class="co">#&gt; 2998:        1.729824        1.346807        1.832182 Sample_3</span></span>
<span><span class="co">#&gt; 2999:        1.779420        1.392996        1.892903 Sample_3</span></span>
<span><span class="co">#&gt; 3000:        1.831867        1.263732        2.008898 Sample_3</span></span>
<span><span class="co">#&gt;                          SuperCellId</span></span>
<span><span class="co">#&gt;                               &lt;char&gt;</span></span>
<span><span class="co">#&gt;    1:    SuperCell_1_Sample_Sample_1</span></span>
<span><span class="co">#&gt;    2:    SuperCell_2_Sample_Sample_1</span></span>
<span><span class="co">#&gt;    3:    SuperCell_3_Sample_Sample_1</span></span>
<span><span class="co">#&gt;    4:    SuperCell_4_Sample_Sample_1</span></span>
<span><span class="co">#&gt;    5:    SuperCell_5_Sample_Sample_1</span></span>
<span><span class="co">#&gt;   ---                               </span></span>
<span><span class="co">#&gt; 2996:  SuperCell_996_Sample_Sample_3</span></span>
<span><span class="co">#&gt; 2997:  SuperCell_997_Sample_Sample_3</span></span>
<span><span class="co">#&gt; 2998:  SuperCell_998_Sample_Sample_3</span></span>
<span><span class="co">#&gt; 2999:  SuperCell_999_Sample_Sample_3</span></span>
<span><span class="co">#&gt; 3000: SuperCell_1000_Sample_Sample_3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $supercell_cell_map</span></span>
<span><span class="co">#&gt;                          SuperCellID     CellId   Sample</span></span>
<span><span class="co">#&gt;                               &lt;char&gt;     &lt;char&gt;   &lt;char&gt;</span></span>
<span><span class="co">#&gt;     1: SuperCell_391_Sample_Sample_1     Cell_1 Sample_1</span></span>
<span><span class="co">#&gt;     2: SuperCell_320_Sample_Sample_1     Cell_2 Sample_1</span></span>
<span><span class="co">#&gt;     3: SuperCell_122_Sample_Sample_1     Cell_3 Sample_1</span></span>
<span><span class="co">#&gt;     4: SuperCell_261_Sample_Sample_1     Cell_4 Sample_1</span></span>
<span><span class="co">#&gt;     5: SuperCell_106_Sample_Sample_1     Cell_5 Sample_1</span></span>
<span><span class="co">#&gt;    ---                                                  </span></span>
<span><span class="co">#&gt; 29996: SuperCell_141_Sample_Sample_3 Cell_29996 Sample_3</span></span>
<span><span class="co">#&gt; 29997: SuperCell_137_Sample_Sample_3 Cell_29997 Sample_3</span></span>
<span><span class="co">#&gt; 29998: SuperCell_171_Sample_Sample_3 Cell_29998 Sample_3</span></span>
<span><span class="co">#&gt; 29999: SuperCell_335_Sample_Sample_3 Cell_29999 Sample_3</span></span>
<span><span class="co">#&gt; 30000: SuperCell_265_Sample_Sample_3 Cell_30000 Sample_3</span></span></code></pre></div>
<p>The output generated by <code>recomputeSupercells</code> is
essentially a list:</p>
<ol style="list-style-type: decimal">
<li>
<code>supercell_expression_matrix</code>: A data.table object that
contains the marker expression for each supercell.</li>
<li>
<code>supercell_cell_map</code>: A data.table that maps each cell to
its corresponding supercell.</li>
</ol>
<p>As mentioned before, gamma dictates the granularity of supercells.
Compared to the previous run where gamma was set to 20, we should get
more supercells for gamma = 10, and less for gamma = 50. Let’s see if
that’s the case.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_supercells_gamma20</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">$</span><span class="va">supercell_expression_matrix</span><span class="op">)</span></span>
<span><span class="va">n_supercells_gamma10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">supercells_addt_gamma</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">supercell_expression_matrix</span><span class="op">)</span></span>
<span><span class="va">n_supercells_gamma50</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">supercells_addt_gamma</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">supercell_expression_matrix</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_supercells_gamma10</span> <span class="op">&gt;</span> <span class="va">n_supercells_gamma20</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_supercells_gamma50</span> <span class="op">&lt;</span> <span class="va">n_supercells_gamma20</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="specifying-different-gamma-value-for-different-samples">Specifying different gamma value for different samples<a class="anchor" aria-label="anchor" href="#specifying-different-gamma-value-for-different-samples"></a>
</h3>
<p>In the future, we may add the ability to specify different
<code>gam</code> value for different samples. For now, if we want to do
this, we will need to break down our data into multiple
<code>data.table</code> objects, each containing data from 1 sample, and
run <code>runSuperCellCyto</code> function on each of them with
different <code>gam</code> parameter value. Something like the
following:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_markers</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simCytoData.html">simCytoData</a></span><span class="op">(</span>nmarkers <span class="op">=</span> <span class="va">n_markers</span><span class="op">)</span></span>
<span><span class="va">markers_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Marker_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_markers</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sample_col</span> <span class="op">&lt;-</span> <span class="st">"Sample"</span></span>
<span><span class="va">cell_id_col</span> <span class="op">&lt;-</span> <span class="st">"Cell_Id"</span></span>
<span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[[</span><span class="va">sample_col</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">gam_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">supercells_diff_gam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sample</span> <span class="op">&lt;-</span> <span class="va">samples</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">gam</span> <span class="op">&lt;-</span> <span class="va">gam_values</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">dat_samp</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">[</span><span class="va">dat</span><span class="op">$</span><span class="va">Sample</span> <span class="op">==</span> <span class="va">sample</span>, <span class="op">]</span></span>
<span>  <span class="va">supercell_samp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSuperCellCyto.html">runSuperCellCyto</a></span><span class="op">(</span></span>
<span>    dt <span class="op">=</span> <span class="va">dat_samp</span>,</span>
<span>    markers <span class="op">=</span> <span class="va">markers_col</span>,</span>
<span>    sample_colname <span class="op">=</span> <span class="va">sample_col</span>,</span>
<span>    cell_id_colname <span class="op">=</span> <span class="va">cell_id_col</span>,</span>
<span>    gam <span class="op">=</span> <span class="va">gam</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">supercell_samp</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Subsequently, to extract and combine the
<code>supercell_expression_matrix</code> and
<code>supercell_cell_map</code>, we will need to use
<code>rbind</code>:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">supercell_expression_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span></span>
<span>  <span class="st">"rbind"</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">supercells_diff_gam</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[[</span><span class="st">"supercell_expression_matrix"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">supercell_cell_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span></span>
<span>  <span class="st">"rbind"</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">supercells_diff_gam</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[[</span><span class="st">"supercell_cell_map"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">supercell_expression_matrix</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">supercell_expression_matrix</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Marker_1 Marker_2  Marker_3  Marker_4 Marker_5 Marker_6 Marker_7  Marker_8</span></span>
<span><span class="co">#&gt;       &lt;num&gt;    &lt;num&gt;     &lt;num&gt;     &lt;num&gt;    &lt;num&gt;    &lt;num&gt;    &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: 15.73648 6.250457  9.116118  6.511608 14.73615 16.45295 19.97692 17.922314</span></span>
<span><span class="co">#&gt; 2: 14.81255 6.849988 10.170519  7.050582 14.73543 16.66027 18.93082 16.852815</span></span>
<span><span class="co">#&gt; 3: 14.26807 7.539579  8.060393  8.047479 14.65910 16.91549 17.83507 16.476958</span></span>
<span><span class="co">#&gt; 4: 18.28681 5.550263  6.185845 14.797749 16.82177 16.84843 17.65490  8.018027</span></span>
<span><span class="co">#&gt; 5: 18.81655 4.332123  7.987095 16.144034 17.77146 16.38018 19.14210  7.458473</span></span>
<span><span class="co">#&gt; 6: 17.72041 6.010915  5.972233 16.755330 17.68510 16.52059 17.57985  8.091039</span></span>
<span><span class="co">#&gt;    Marker_9 Marker_10   Sample                   SuperCellId</span></span>
<span><span class="co">#&gt;       &lt;num&gt;     &lt;num&gt;   &lt;char&gt;                        &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: 16.76650  8.574489 Sample_1   SuperCell_1_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 2: 16.41617  9.336134 Sample_1   SuperCell_2_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 3: 15.20695  7.794689 Sample_1   SuperCell_3_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 4: 13.08104  5.942050 Sample_2 SuperCell_498_Sample_Sample_2</span></span>
<span><span class="co">#&gt; 5: 10.72360  7.076911 Sample_2 SuperCell_499_Sample_Sample_2</span></span>
<span><span class="co">#&gt; 6: 12.06918  5.504288 Sample_2 SuperCell_500_Sample_Sample_2</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">supercell_cell_map</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">supercell_cell_map</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;                      SuperCellID     CellId   Sample</span></span>
<span><span class="co">#&gt;                           &lt;char&gt;     &lt;char&gt;   &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: SuperCell_609_Sample_Sample_1     Cell_1 Sample_1</span></span>
<span><span class="co">#&gt; 2: SuperCell_108_Sample_Sample_1     Cell_2 Sample_1</span></span>
<span><span class="co">#&gt; 3: SuperCell_882_Sample_Sample_1     Cell_3 Sample_1</span></span>
<span><span class="co">#&gt; 4:   SuperCell_3_Sample_Sample_2 Cell_19998 Sample_2</span></span>
<span><span class="co">#&gt; 5: SuperCell_228_Sample_Sample_2 Cell_19999 Sample_2</span></span>
<span><span class="co">#&gt; 6:  SuperCell_61_Sample_Sample_2 Cell_20000 Sample_2</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="mixing-cells-from-different-samples-in-a-supercell">Mixing cells from different samples in a supercell<a class="anchor" aria-label="anchor" href="#mixing-cells-from-different-samples-in-a-supercell"></a>
</h2>
<p>If for whatever reason you don’t mind (or perhaps more to the point
want) each supercell to contain cells from different biological samples,
you still need to have the sample column in your
<code>data.table</code>. However, what you need to do is essentially set
the value in the column to exactly one <strong><em>unique</em></strong>
value. That way, SuperCellCyto will treat all cells as coming from one
sample.</p>
<p>Just note, the parallel processing feature in SuperCellCyto won’t
work for this as you will essentially only have 1 sample and nothing for
SuperCellCyto to parallelise.</p>
</div>
<div class="section level2">
<h2 id="i-have-more-cells-than-ram-in-my-computer">I have more cells than RAM in my computer<a class="anchor" aria-label="anchor" href="#i-have-more-cells-than-ram-in-my-computer"></a>
</h2>
<p>Is your dataset so huge that you are constantly running out of RAM
when generating supercells? This thing happens and we have a solution
for it.</p>
<p>Since supercells are generated for each sample independent of others
you can easily break up the process. For example:</p>
<ol style="list-style-type: decimal">
<li>Load up a subset of the samples (say 1-10).</li>
<li>Generate supercells for those samples.</li>
<li>Save the output using the <a href="https://cran.r-project.org/web/packages/qs/index.html" class="external-link">qs
package</a>.</li>
<li>Extract the <code>supercell_expression_matrix</code> and
<code>supercell_cell_map</code>, and export them out as a csv file using
<code>data.table</code>’s <code>fwrite</code> function.</li>
<li>Load another sets of samples (say 11-20), rinse and repeat step
2-4.</li>
</ol>
<p>Once you have processed all the samples, you can then load all
<code>supercell_expression_matrix</code> and
<code>supercell_cell_map</code> csv files and analyse them.</p>
<p>If you want to regenerate the supercells using different gamma
values, load the relevant output saved using the qs package and the
relevant data (remember to note which output belongs to which sets of
samples!), and run <code>recomputeSupercells</code> function.</p>
</div>
<div class="section level2">
<h2 id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; R version 4.3.2 (2023-10-31)</span></span>
<span><span class="co">#&gt; Platform: x86_64-pc-linux-gnu (64-bit)</span></span>
<span><span class="co">#&gt; Running under: Ubuntu 22.04.3 LTS</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so;  LAPACK version 3.10.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt;  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">#&gt;  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">#&gt;  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">#&gt; [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: UTC</span></span>
<span><span class="co">#&gt; tzcode source: system (glibc)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] parallel  stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">#&gt; [8] base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt; [1] BiocParallel_1.36.0 SuperCellCyto_0.1.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;  [1] Matrix_1.6-5      jsonlite_1.8.8    compiler_4.3.2    Rcpp_1.0.12      </span></span>
<span><span class="co">#&gt;  [5] stringr_1.5.1     SuperCell_1.0     jquerylib_0.1.4   systemfonts_1.0.5</span></span>
<span><span class="co">#&gt;  [9] textshaping_0.3.7 yaml_2.3.8        fastmap_1.1.1     lattice_0.21-9   </span></span>
<span><span class="co">#&gt; [13] plyr_1.8.9        R6_2.5.1          igraph_2.0.1.1    knitr_1.45       </span></span>
<span><span class="co">#&gt; [17] desc_1.4.3        bslib_0.6.1       rlang_1.1.3       cachem_1.0.8     </span></span>
<span><span class="co">#&gt; [21] stringi_1.8.3     RANN_2.6.1        xfun_0.42         fs_1.6.3         </span></span>
<span><span class="co">#&gt; [25] sass_0.4.8        memoise_2.0.1     cli_3.6.2         pkgdown_2.0.7    </span></span>
<span><span class="co">#&gt; [29] magrittr_2.0.3    digest_0.6.34     grid_4.3.2        lifecycle_1.0.4  </span></span>
<span><span class="co">#&gt; [33] vctrs_0.6.5       evaluate_0.23     glue_1.7.0        data.table_1.15.0</span></span>
<span><span class="co">#&gt; [37] codetools_0.2-19  ragg_1.2.7        rmarkdown_2.25    purrr_1.0.2      </span></span>
<span><span class="co">#&gt; [41] pkgconfig_2.0.3   tools_4.3.2       htmltools_0.5.7</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Givanna Putri, George Howitt, Felix Marsh-Wakefield, Thomas Ashhurst, Belinda Phipson.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
