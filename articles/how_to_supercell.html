<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="SuperCellCyto">
<title>How to create supercells • SuperCellCyto</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="How to create supercells">
<meta property="og:description" content="SuperCellCyto">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">SuperCellCyto</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.99.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/how_to_supercell.html">How to create supercells</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>How to create supercells</h1>
                        <h4 data-toc-skip class="author">Givanna
Putri</h4>
            
      
      
      <div class="d-none name"><code>how_to_supercell.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette describes the steps to reduce the size of vast
high-dimensional cytometry data using SuperCellCyto, an R package based
on the <a href="https://github.com/GfellerLab/SuperCell" class="external-link">SuperCell R
package</a> by David Gfeller lab from the University of Lausanne.</p>
<p>Please note that we’re still actively updating this vignette (and in
fact the package itself), and that we welcome any feedbacks on how to
improve them. There are myriad of ways on how to use SuperCell. While we
try to cover as many use cases as possible, we bound to miss something.
In that case, please reach out through the github repository by creating
a Github issue.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>To install SuprCellCyto, we need to use the <code>devtools</code>
package from CRAN. You can install <code>devtools</code> by using the
<code>install.packages("devtools")</code> command.</p>
<p>Thereafter, you can install SuperCellCyto using
<code>devtools::install_github("phipsonlab/SuperCellCyto")</code>.</p>
<p>SuperCellCyto requires the <a href="https://github.com/GfellerLab/SuperCell" class="external-link">SuperCell R package</a>
installed to run properly. If you use the
<code><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">devtools::install_github</a></code> command above to install
SuperCellCyto, it should be, in theory, automatically installed. But in
the case it doesn’t, you can manually install it by using
<code>devtools::install_github("GfellerLab/SuperCell")</code>.</p>
</div>
<div class="section level2">
<h2 id="preparing-your-dataset">Preparing your dataset<a class="anchor" aria-label="anchor" href="#preparing-your-dataset"></a>
</h2>
<p>The function which creates supercells is called
<code>runSuperCellCyto</code>, and it operates on a
<code>data.table</code> object, an enhanced version of R native
<code>data.frame</code>. We may add some support for
<code>SummarizedExperiment</code> or <code>flowFrame</code> object in
the future if there are enough demands for it.</p>
<p>If the raw data is stored in a csv file, we can import it into a
<code>data.table</code> object using their <code>fread</code>
function.</p>
<p>If the raw data is stored across multiple csv files or FCS files
(more common for cytometry), then we will need the help of <a href="https://github.com/ImmuneDynamics/Spectre" class="external-link">Spectre</a> R package
to import them as a<code>data.table</code> object. Specifically, we need
to:</p>
<ol style="list-style-type: decimal">
<li>Run <code>read.files</code> function to read in the FCS or csv
files.</li>
<li>Run <code>do.merge.files</code> to merge the resulting
<code>data.table</code> objects into one.</li>
</ol>
<p>If you are unsure as to how these steps will work out, have a look at
an example in this <a href="https://immunedynamics.io/spectre/simple-discovery/#2_Import_and_prep_data" class="external-link">Spectre
vignette</a>.</p>
<p>Using the vignette above, if you have csv files, you can run the
steps in that vignette as they are, <strong><em>but</em></strong> only
after changing the <code>InputDirectory</code> variable. If you have FCS
files, you need to change the <code>file.type</code> parameter for the
<code>read.files</code> function to <code>.fcs</code>.</p>
<p>For this vignette, we will simulate some toy data using the
<code>simCytoData</code> function.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_markers</span> <span class="op">&lt;-</span> <span class="fl">15</span></span>
<span><span class="va">n_samples</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">SuperCellCyto</span><span class="fu">::</span><span class="fu"><a href="../reference/simCytoData.html">simCytoData</a></span><span class="op">(</span>nmarkers <span class="op">=</span> <span class="va">n_markers</span>, ncells <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">10000</span>, <span class="va">n_samples</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Marker_1 Marker_2 Marker_3 Marker_4 Marker_5  Marker_6  Marker_7 Marker_8</span></span>
<span><span class="co">#&gt; 1: 16.91017 13.34117 5.125612 13.06094 7.424589 11.129842  9.889255 12.76685</span></span>
<span><span class="co">#&gt; 2: 18.97628 14.20116 5.643169 13.54070 6.085112 10.088370 11.090095 10.86346</span></span>
<span><span class="co">#&gt; 3: 16.99298 14.32873 5.906140 15.09873 8.687531 10.368009  9.911772 11.15815</span></span>
<span><span class="co">#&gt; 4: 17.55536 14.11274 4.793605 16.45142 6.816658 11.808160 11.449758 11.02747</span></span>
<span><span class="co">#&gt; 5: 17.81480 13.82376 6.102579 13.72391 7.105803  8.873469  9.328432 11.74787</span></span>
<span><span class="co">#&gt; 6: 16.20900 12.89090 3.035170 14.10797 6.655405  7.903983 10.840602 10.78638</span></span>
<span><span class="co">#&gt;    Marker_9 Marker_10 Marker_11 Marker_12 Marker_13 Marker_14 Marker_15</span></span>
<span><span class="co">#&gt; 1: 15.47709  20.38725  18.23757  18.05178  8.973562 10.887634  5.628093</span></span>
<span><span class="co">#&gt; 2: 14.74135  19.76484  14.83495  18.16493  7.415901  7.298694  6.077525</span></span>
<span><span class="co">#&gt; 3: 14.61532  19.23760  16.74040  17.72182  7.141651  8.161016  8.514925</span></span>
<span><span class="co">#&gt; 4: 17.24710  19.66106  15.92138  19.29263  9.865540 11.267993  5.773753</span></span>
<span><span class="co">#&gt; 5: 14.85617  19.44734  15.91717  20.63053 10.527723 11.123647  7.935485</span></span>
<span><span class="co">#&gt; 6: 16.11953  18.24382  15.55453  21.47276  8.419940  8.472888  6.207577</span></span>
<span><span class="co">#&gt;      Sample Cell_Id</span></span>
<span><span class="co">#&gt; 1: Sample_1  Cell_1</span></span>
<span><span class="co">#&gt; 2: Sample_1  Cell_2</span></span>
<span><span class="co">#&gt; 3: Sample_1  Cell_3</span></span>
<span><span class="co">#&gt; 4: Sample_1  Cell_4</span></span>
<span><span class="co">#&gt; 5: Sample_1  Cell_5</span></span>
<span><span class="co">#&gt; 6: Sample_1  Cell_6</span></span></code></pre></div>
<p>There are several things to note about our dataset. Let’s go through
them one by one in each sub-section below.</p>
<div class="section level3">
<h3 id="the-markers">The markers<a class="anchor" aria-label="anchor" href="#the-markers"></a>
</h3>
<p>The <code>runSuperCellCyto</code> function does not perform any data
transformation or scaling. Thus, we must ensure that our dataset have
already been appropriately transformed using either the arc-sinh
transformation or linear binning (using FlowJo). This tutorial explains
the data transformation process in very great detail: (<a href="https://wiki.centenary.org.au/display/SPECTRE/Data+transformation" class="external-link uri">https://wiki.centenary.org.au/display/SPECTRE/Data+transformation</a>).
Please have a read if you are unsure how to transform your data.</p>
<p>For our toy dataset, we will transform our data using the arc-sinh
transformation implementation provided by the base R <code>asinh</code>
function:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Specify which columns are the markers to transform</span></span>
<span><span class="va">marker_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Marker_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_markers</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># The co-factor for arc-sinh</span></span>
<span><span class="va">cofactor</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span></span>
<span><span class="co"># Do the transformation</span></span>
<span><span class="va">dat_asinh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Hyperbolic.html" class="external-link">asinh</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[</span>, <span class="va">marker_cols</span>, with <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span> <span class="op">/</span> <span class="va">cofactor</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rename the new columns</span></span>
<span><span class="va">marker_cols_asinh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">marker_cols</span>, <span class="st">"_asinh"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat_asinh</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">marker_cols_asinh</span></span>
<span></span>
<span><span class="co"># Add them our previously loaded data</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">dat_asinh</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[</span>, <span class="va">marker_cols_asinh</span>, with <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Marker_1_asinh Marker_2_asinh Marker_3_asinh Marker_4_asinh Marker_5_asinh</span></span>
<span><span class="co">#&gt; 1:       1.932797       1.707962      0.8990267       1.688110       1.186368</span></span>
<span><span class="co">#&gt; 2:       2.043820       1.766675      0.9694717       1.721875       1.026825</span></span>
<span><span class="co">#&gt; 3:       1.937483       1.775115      1.0038999       1.824672       1.319682</span></span>
<span><span class="co">#&gt; 4:       1.968758       1.760785      0.8518817       1.906453       1.116483</span></span>
<span><span class="co">#&gt; 5:       1.982875       1.741307      1.0290410       1.734493       1.150220</span></span>
<span><span class="co">#&gt; 6:       1.892258       1.675881      0.5748472       1.760467       1.097260</span></span>
<span><span class="co">#&gt;    Marker_6_asinh Marker_7_asinh Marker_8_asinh Marker_9_asinh Marker_10_asinh</span></span>
<span><span class="co">#&gt; 1:       1.540354       1.433686       1.666872       1.848196        2.113328</span></span>
<span><span class="co">#&gt; 2:       1.451512       1.537092       1.518302       1.801960        2.083242</span></span>
<span><span class="co">#&gt; 3:       1.476075       1.435716       1.542672       1.793832        2.057052</span></span>
<span><span class="co">#&gt; 4:       1.594580       1.566265       1.531931       1.951731        2.078139</span></span>
<span><span class="co">#&gt; 5:       1.338085       1.381903       1.589868       1.809311        2.067550</span></span>
<span><span class="co">#&gt; 6:       1.238761       1.516389       1.511838       1.886970        2.005806</span></span>
<span><span class="co">#&gt;    Marker_11_asinh Marker_12_asinh Marker_13_asinh Marker_14_asinh</span></span>
<span><span class="co">#&gt; 1:        2.005475        1.995604        1.347870        1.520321</span></span>
<span><span class="co">#&gt; 2:        1.807956        2.001627        1.185397        1.172221</span></span>
<span><span class="co">#&gt; 3:        1.923125        1.977837        1.154339        1.265928</span></span>
<span><span class="co">#&gt; 4:        1.875163        2.059817        1.431544        1.551618</span></span>
<span><span class="co">#&gt; 5:        1.874911        2.124852        1.489864        1.539846</span></span>
<span><span class="co">#&gt; 6:        1.852946        2.163782        1.292673        1.298068</span></span>
<span><span class="co">#&gt;    Marker_15_asinh</span></span>
<span><span class="co">#&gt; 1:       0.9674706</span></span>
<span><span class="co">#&gt; 2:       1.0258614</span></span>
<span><span class="co">#&gt; 3:       1.3023329</span></span>
<span><span class="co">#&gt; 4:       0.9866798</span></span>
<span><span class="co">#&gt; 5:       1.2421249</span></span>
<span><span class="co">#&gt; 6:       1.0422817</span></span></code></pre></div>
<p>Breaking down the steps, we:</p>
<ol style="list-style-type: decimal">
<li>Identify the columns denoting the markers.</li>
<li>Set the co-factor to 5.</li>
<li>Do the transformation and store it in <code>dat_asinh</code>
variable.</li>
<li>Set the <code>dat_asinh</code> column name to reflect that the
values in each column (marker) haas undergone an arc-sinh
transformation.</li>
<li>Combine <code>dat</code> and <code>dat_asinh</code> using
<code>cbind</code>.</li>
</ol>
</div>
<div class="section level3">
<h3 id="cell-id-column">Cell id column<a class="anchor" aria-label="anchor" href="#cell-id-column"></a>
</h3>
<p>To create supercell, we must provide a column which uniquely identify
each cell, akin to the <code>Cell_Id</code> column in the toy data we
generated above:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">Cell_Id</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "Cell_1"  "Cell_2"  "Cell_3"  "Cell_4"  "Cell_5"  "Cell_6"  "Cell_7" </span></span>
<span><span class="co">#&gt;  [8] "Cell_8"  "Cell_9"  "Cell_10"</span></span></code></pre></div>
<p>The purpose of cell id is to allow SuperCell to uniquely identify
each cell in the dataset. This ID will come in super handy later when/if
we need to work out which cells belong to which supercells.</p>
<p>Generally, we will need to create this ID ourselves. Most dataset
won’t come with this ID already embedded in. A simple cell id can be
made up by concatenating the word <code>Cell</code> with the row number.
Something like the following:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span><span class="op">$</span><span class="va">Cell_id_dummy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Cell_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">Cell_id_dummy</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "Cell_1"  "Cell_2"  "Cell_3"  "Cell_4"  "Cell_5"  "Cell_6"  "Cell_7" </span></span>
<span><span class="co">#&gt;  [8] "Cell_8"  "Cell_9"  "Cell_10"</span></span></code></pre></div>
<p>Here, we store the cell id in a column called
<code>Cell_id_dummy</code>. It has values such as
<code>Cell_1, Cell_2,</code> all the way until <code>Cell_x</code> where
x is the number of cells in the dataset.</p>
<p>Note, we can name the cell id column however we like,
<code>id, cell_identity</code>, etc. Importantly, we need make sure we
note the column name as we will need to pass it to the
<code>runSuperCellCyto</code> function later.</p>
</div>
<div class="section level3">
<h3 id="sample-column">Sample column<a class="anchor" aria-label="anchor" href="#sample-column"></a>
</h3>
<p>You will notice that in the toy data above, we have a column called
<code>Sample</code>. By default, this column refers to the biological
sample the cells come from. In the toy data above, we have 3 samples,
<code>Sample_1, Sample_2, Sample_3</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">Sample</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Sample_1" "Sample_2" "Sample_3"</span></span></code></pre></div>
<p>and we have 10,000 cells per sample:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">Sample</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample_1 Sample_2 Sample_3 </span></span>
<span><span class="co">#&gt;    10000    10000    10000</span></span></code></pre></div>
<p>To create supercells, it is necessary to have this
<code>Sample</code> column in our dataset. We can name the column
however we like, <code>Samp, Cell_Samp</code>. However, we make sure we
note the column name as we will need to pass it to the
<code>runSuperCellCyto</code> function. More on this in [Creating
supercells][#creating-supercells] section.</p>
<p>But what if we only have 1 biological sample in our dataset? It does
not matter. We still need to have this column in our dataset, and pass
the column name to the <code>runSuperCellCyto</code> function. The only
difference is that this column will only have 1 unique value.</p>
<p>Why do we need to do this? To ensure that each supercell only
contains cells from exactly 1 sample. This is because, in general, it
does not make sense to mix cells from different biological samples in
one supercell. Additionally (not as important), the
<code>runSuperCellCyto</code> function can process all the samples in
parallel if you set its <code>BPPARAM</code> parameter to a
<code>BiocParallelParam</code> class that leverage parallel processing.
More on this in <a href="#running-runsupercellcyto-in-parallel">Running
runSuperCellCyto in parallel</a> section below.</p>
<p>However, if you want each supercell to contain cells from different
biological samples, then you need to create a new <code>Sample</code>
column containing exactly 1 <strong><em>unique</em></strong> value, and
pass the column name to <code>runSuperCellCyto</code> function.</p>
<p>: You may wonder whether it is possible to use
<code>SuperCellCyto</code> to reduce the number of cells captured in
each cluster (or cell type) so we can make a UMAP/tSNE plot that is not
as crowded? Commonly in cytometry, we use stratified sampling to
subsample our clusters before drawing UMAP/tSNE plot to avoid
overcrowding it.</p>
<p>The short answer is, yes you can. See <a href="#using-runsupercellcyto-for-stratified-summarising">Using
runSuperCellCyto for stratified summarising</a> section for more
information.</p>
</div>
</div>
<div class="section level2">
<h2 id="creating-supercells">Creating supercells<a class="anchor" aria-label="anchor" href="#creating-supercells"></a>
</h2>
<p>Now that we have imported our data, let’s create some supercells.</p>
<p>First, let’s store the markers, sample, and cell id column in
variables:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">markers_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Marker_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_markers</span><span class="op">)</span>, <span class="st">"_asinh"</span><span class="op">)</span></span>
<span><span class="va">sample_col</span> <span class="op">&lt;-</span> <span class="st">"Sample"</span></span>
<span><span class="va">cell_id_col</span> <span class="op">&lt;-</span> <span class="st">"Cell_Id_dummy"</span></span></code></pre></div>
<p>Then pass all of that, together with the dataset into
<code>runSuperCellCyto</code> function to create supercells:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">supercells</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSuperCellCyto.html">runSuperCellCyto</a></span><span class="op">(</span></span>
<span>  dt <span class="op">=</span> <span class="va">dat</span>,</span>
<span>  markers <span class="op">=</span> <span class="va">markers_col</span>,</span>
<span>  sample_colname <span class="op">=</span> <span class="va">sample_col</span>,</span>
<span>  cell_id_colname <span class="op">=</span> <span class="va">cell_id_col</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in SCimplify(X = mt, genes.use = rownames(mt), do.scale = FALSE, : colnames(X) is Null, </span></span>
<span><span class="co">#&gt; Gene expression matrix X is expected to have cellIDs as colnames! </span></span>
<span><span class="co">#&gt; CellIDs will be created automatically in a form 'cell_i'</span></span>
<span></span>
<span><span class="co">#&gt; Warning in SCimplify(X = mt, genes.use = rownames(mt), do.scale = FALSE, : colnames(X) is Null, </span></span>
<span><span class="co">#&gt; Gene expression matrix X is expected to have cellIDs as colnames! </span></span>
<span><span class="co">#&gt; CellIDs will be created automatically in a form 'cell_i'</span></span>
<span></span>
<span><span class="co">#&gt; Warning in SCimplify(X = mt, genes.use = rownames(mt), do.scale = FALSE, : colnames(X) is Null, </span></span>
<span><span class="co">#&gt; Gene expression matrix X is expected to have cellIDs as colnames! </span></span>
<span><span class="co">#&gt; CellIDs will be created automatically in a form 'cell_i'</span></span></code></pre></div>
<p>Now let’s dig deeper into the object it created:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "list"</span></span></code></pre></div>
<p>It is a list containing 3 elements:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "supercell_expression_matrix" "supercell_cell_map"         </span></span>
<span><span class="co">#&gt; [3] "supercell_object"</span></span></code></pre></div>
<div class="section level3">
<h3 id="supercell-object">Supercell object<a class="anchor" aria-label="anchor" href="#supercell-object"></a>
</h3>
<p>The <code>supercell_object</code> contains the metadata used to
create the supercells. It is a list, and each element contains the
metadata used to create the supercells for a sample. This will come in
handy if we need to debug the supercells later down the line.</p>
</div>
<div class="section level3">
<h3 id="supercell-expression-matrix">Supercell expression matrix<a class="anchor" aria-label="anchor" href="#supercell-expression-matrix"></a>
</h3>
<p>The <code>supercell_expression_matrix</code> contains the marker
expression of each supercell. These are calculated by taking the average
of the marker expression of all the cells contained within a
supercell.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">$</span><span class="va">supercell_expression_matrix</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Marker_1_asinh Marker_2_asinh Marker_3_asinh Marker_4_asinh Marker_5_asinh</span></span>
<span><span class="co">#&gt; 1:       1.949595       1.700565      0.8654397       1.830513      1.0239864</span></span>
<span><span class="co">#&gt; 2:       1.931518       1.769663      0.9973663       1.785468      1.0830003</span></span>
<span><span class="co">#&gt; 3:       1.971973       1.757669      1.1761088       1.799300      1.0733333</span></span>
<span><span class="co">#&gt; 4:       1.943747       1.757619      0.8034572       1.774716      0.8125315</span></span>
<span><span class="co">#&gt; 5:       1.949957       1.789683      1.0032823       1.768977      1.0675305</span></span>
<span><span class="co">#&gt; 6:       1.959270       1.747160      1.0606154       1.812937      1.0959029</span></span>
<span><span class="co">#&gt;    Marker_6_asinh Marker_7_asinh Marker_8_asinh Marker_9_asinh Marker_10_asinh</span></span>
<span><span class="co">#&gt; 1:       1.511292       1.393771       1.516510       1.852178        2.073018</span></span>
<span><span class="co">#&gt; 2:       1.504903       1.532782       1.530864       1.838109        2.084718</span></span>
<span><span class="co">#&gt; 3:       1.495517       1.372246       1.497558       1.857757        2.112608</span></span>
<span><span class="co">#&gt; 4:       1.507222       1.483572       1.503961       1.851257        2.078325</span></span>
<span><span class="co">#&gt; 5:       1.395245       1.510235       1.371866       1.862841        2.109750</span></span>
<span><span class="co">#&gt; 6:       1.461915       1.449723       1.582583       1.863827        2.103202</span></span>
<span><span class="co">#&gt;    Marker_11_asinh Marker_12_asinh Marker_13_asinh Marker_14_asinh</span></span>
<span><span class="co">#&gt; 1:        1.876840        2.050051        1.246261        1.210775</span></span>
<span><span class="co">#&gt; 2:        1.872914        2.072848        1.133082        1.417099</span></span>
<span><span class="co">#&gt; 3:        1.915918        2.065970        1.448747        1.399785</span></span>
<span><span class="co">#&gt; 4:        1.903641        2.062705        1.267394        1.263482</span></span>
<span><span class="co">#&gt; 5:        1.908601        2.046286        1.431223        1.356147</span></span>
<span><span class="co">#&gt; 6:        1.904674        2.051956        1.298558        1.278367</span></span>
<span><span class="co">#&gt;    Marker_15_asinh   Sample                 SuperCellId</span></span>
<span><span class="co">#&gt; 1:       0.9958950 Sample_1 SuperCell_1_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 2:       0.9969006 Sample_1 SuperCell_2_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 3:       0.9821248 Sample_1 SuperCell_3_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 4:       0.9747845 Sample_1 SuperCell_4_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 5:       1.2007546 Sample_1 SuperCell_5_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 6:       1.2378164 Sample_1 SuperCell_6_Sample_Sample_1</span></span></code></pre></div>
<p>Therein, we will have the following columns:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">$</span><span class="va">supercell_expression_matrix</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "Marker_1_asinh"  "Marker_2_asinh"  "Marker_3_asinh"  "Marker_4_asinh" </span></span>
<span><span class="co">#&gt;  [5] "Marker_5_asinh"  "Marker_6_asinh"  "Marker_7_asinh"  "Marker_8_asinh" </span></span>
<span><span class="co">#&gt;  [9] "Marker_9_asinh"  "Marker_10_asinh" "Marker_11_asinh" "Marker_12_asinh"</span></span>
<span><span class="co">#&gt; [13] "Marker_13_asinh" "Marker_14_asinh" "Marker_15_asinh" "Sample"         </span></span>
<span><span class="co">#&gt; [17] "SuperCellId"</span></span></code></pre></div>
<ol style="list-style-type: decimal">
<li>All the markers we previously specified in the
<code>markers_col</code> variable.</li>
<li>A column (<code>Sample</code> in this case) denoting which sample a
supercell belongs to, (note the column name is the same as what is
stored in <code>sample_col</code> variable).</li>
<li>The <code>SuperCellId</code> column denoting the unique ID of the
supercell.</li>
</ol>
<div class="section level4">
<h4 id="supercellid">SuperCellId<a class="anchor" aria-label="anchor" href="#supercellid"></a>
</h4>
<p>Let’s have a look at <code>SuperCellId</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">$</span><span class="va">supercell_expression_matrix</span><span class="op">$</span><span class="va">SuperCellId</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "SuperCell_1_Sample_Sample_1" "SuperCell_2_Sample_Sample_1"</span></span>
<span><span class="co">#&gt; [3] "SuperCell_3_Sample_Sample_1" "SuperCell_4_Sample_Sample_1"</span></span>
<span><span class="co">#&gt; [5] "SuperCell_5_Sample_Sample_1" "SuperCell_6_Sample_Sample_1"</span></span></code></pre></div>
<p>Let’s break down one of them,
<code>SuperCell_1_Sample_Sample_1</code>. <code>SuperCell_1</code> is a
numbering (1 to however many supercells there are in a sample) used to
uniquely identify each supercell in a sample. Notably, you may encounter
this (<code>SuperCell_1</code>, <code>SuperCell_2</code>) being repeated
across different samples, e.g.,</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">supercell_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">$</span><span class="va">supercell_expression_matrix</span><span class="op">$</span><span class="va">SuperCellId</span><span class="op">)</span></span>
<span><span class="va">supercell_ids</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"SuperCell_1_"</span>, <span class="va">supercell_ids</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] "SuperCell_1_Sample_Sample_1" "SuperCell_1_Sample_Sample_2"</span></span>
<span><span class="co">#&gt; [3] "SuperCell_1_Sample_Sample_3"</span></span></code></pre></div>
<p>While these 3 supercells’ id are pre-fixed with
<code>SuperCell_1</code>, it does not make them equal to one another!
<code>SuperCell_1_Sample_Sample_1</code> will only contain cells from
<code>Sample_1</code> while <code>SuperCell_1_Sample_Sample_2</code>
will only contain cells from <code>Sample_2</code>.</p>
<p>By now, you may have noticed that we appended the sample name into
each supercell id. This aids in differentiating the supercells in
different samples.</p>
</div>
</div>
<div class="section level3">
<h3 id="supercell-cell-map">Supercell cell map<a class="anchor" aria-label="anchor" href="#supercell-cell-map"></a>
</h3>
<p><code>supercell_cell_map</code> maps each cell in our dataset to the
supercell it belongs to.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">$</span><span class="va">supercell_cell_map</span><span class="op">)</span></span>
<span><span class="co">#&gt;                      SuperCellID   Sample</span></span>
<span><span class="co">#&gt; 1: SuperCell_250_Sample_Sample_1 Sample_1</span></span>
<span><span class="co">#&gt; 2: SuperCell_486_Sample_Sample_1 Sample_1</span></span>
<span><span class="co">#&gt; 3: SuperCell_139_Sample_Sample_1 Sample_1</span></span>
<span><span class="co">#&gt; 4:  SuperCell_19_Sample_Sample_1 Sample_1</span></span>
<span><span class="co">#&gt; 5: SuperCell_187_Sample_Sample_1 Sample_1</span></span>
<span><span class="co">#&gt; 6: SuperCell_133_Sample_Sample_1 Sample_1</span></span></code></pre></div>
<p>This map is very useful if we later need to expand the supercells
out. Additionally, this is also the reason why we need to have a column
in the dataset which uniquely identify each cell.</p>
</div>
</div>
<div class="section level2">
<h2 id="running-runsupercellcyto-in-parallel">Running <code>runSuperCellCyto</code> in parallel<a class="anchor" aria-label="anchor" href="#running-runsupercellcyto-in-parallel"></a>
</h2>
<p>By default, <code>runSuperCellCyto</code> will process each sample
one after the other. As each sample is processed independent of one
another, we can process all of them in parallel.</p>
<p>To do this, we need to create a <code>BiocParallelParam</code> object
that leverages parallel processing. Additionally, we will also set the
number of tasks to the number of samples, and set the
<code>load_balancing</code> parameter to TRUE so jobs that are
supercelling large samples are not assigned small samples (they will
instead be given to those that are supercelling smaller samples).</p>
<p>Notably, we should not set more workers than the total number of
cores we have in the computer, as it will render your computer useless
for anything else (and it might blow out your RAM). To find out the
total number of cores we have in the computer, we can use parallel’s
detectCores.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_cores</span> <span class="op">&lt;-</span> <span class="fu">detectCores</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">supercell_par</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSuperCellCyto.html">runSuperCellCyto</a></span><span class="op">(</span></span>
<span>  dt <span class="op">=</span> <span class="va">dat</span>,</span>
<span>  markers <span class="op">=</span> <span class="va">markers_col</span>,</span>
<span>  sample_colname <span class="op">=</span> <span class="va">sample_col</span>,</span>
<span>  cell_id_colname <span class="op">=</span> <span class="va">cell_id_col</span>,</span>
<span>  BPPARAM <span class="op">=</span> <span class="fu">MulticoreParam</span><span class="op">(</span></span>
<span>    workers <span class="op">=</span> <span class="va">n_cores</span> <span class="op">-</span> <span class="fl">1</span>,</span>
<span>    tasks <span class="op">=</span> <span class="va">n_samples</span></span>
<span>  <span class="op">)</span>,</span>
<span>  load_balancing <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="controlling-the-supercells-granularity">Controlling the supercells’ granularity<a class="anchor" aria-label="anchor" href="#controlling-the-supercells-granularity"></a>
</h2>
<p>This is described in the <code>runSuperCellCyto</code> function’s
documentation, but let’s briefly go through it here.</p>
<p>The <code>runSuperCellCyto</code> function is equipped with various
parameters which can be customise to alter the composition of the
supercells. The one is very likely to be used the most is the
<code>gam</code> parameter.</p>
<p>The <code>gam</code> parameter controls how many supercells to
generate, and indirectly, how many cells are captured within each
supercell. This parameter is resolved into the following formula
<code>gam=n_cells/n_supercells</code> where <code>n_cell</code> denotes
the number of cells and <code>n_supercells</code> denotes the number of
supercells.</p>
<p>In general, the larger <code>gam</code> parameter is set to, the less
supercells we will get. Say for instance we have 10,000 cells. If
<code>gam</code> is set to 10, we will end up with about 1,000
supercells, whereas if <code>gam</code> is set to 50, we will end up
with about 200 supercells.</p>
<p>You may have noticed, after reading the sections above,
<code>runSuperCellCyto</code> is ran on each sample independent of each
other, and that we can only set 1 value as the <code>gam</code>
parameter. Indeed, for now, the same <code>gam</code> value will be used
across all samples, and that depending on how many cells we have in each
sample, we will end up with different number of supercells for each
sample. For instance, say we have 10,000 cells for sample 1, and 100,000
cells for sample 2. If <code>gam</code> is set to 10, for sample 1, we
will get 1,000 supercells (10,000/10) while for sample 2, we will get
10,000 supercells (100,000/10).</p>
<p>In the future, we may add the ability to specify different
<code>gam</code> value for different samples. For now, if we want to do
this, we will need to break down our data into multiple
<code>data.table</code> objects, each containing data from 1 sample, and
run <code>runSuperCellCyto</code> function on each of them with
different <code>gam</code> parameter value. Something like the
following:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_markers</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simCytoData.html">simCytoData</a></span><span class="op">(</span>nmarkers <span class="op">=</span> <span class="va">n_markers</span><span class="op">)</span></span>
<span><span class="va">markers_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Marker_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_markers</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sample_col</span> <span class="op">&lt;-</span> <span class="st">"Sample"</span></span>
<span><span class="va">cell_id_col</span> <span class="op">&lt;-</span> <span class="st">"Cell_Id"</span></span>
<span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[[</span><span class="va">sample_col</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">gam_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">supercells_diff_gam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sample</span> <span class="op">&lt;-</span> <span class="va">samples</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">gam</span> <span class="op">&lt;-</span> <span class="va">gam_values</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">dat_samp</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">[</span><span class="va">dat</span><span class="op">$</span><span class="va">Sample</span> <span class="op">==</span> <span class="va">sample</span>, <span class="op">]</span></span>
<span>  <span class="va">supercell_samp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSuperCellCyto.html">runSuperCellCyto</a></span><span class="op">(</span></span>
<span>    dt <span class="op">=</span> <span class="va">dat_samp</span>,</span>
<span>    markers <span class="op">=</span> <span class="va">markers_col</span>,</span>
<span>    sample_colname <span class="op">=</span> <span class="va">sample_col</span>,</span>
<span>    cell_id_colname <span class="op">=</span> <span class="va">cell_id_col</span>,</span>
<span>    gam <span class="op">=</span> <span class="va">gam</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">supercell_samp</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Subsequently, to extract and combine the
<code>supercell_expression_matrix</code> and
<code>supercell_cell_map</code>, we will need to use
<code>rbind</code>:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">supercell_expression_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span></span>
<span>  <span class="st">"rbind"</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">supercells_diff_gam</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[[</span><span class="st">"supercell_expression_matrix"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">supercell_cell_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span></span>
<span>  <span class="st">"rbind"</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">supercells_diff_gam</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[[</span><span class="st">"supercell_cell_map"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">supercell_expression_matrix</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">supercell_expression_matrix</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Marker_1 Marker_2 Marker_3 Marker_4  Marker_5  Marker_6  Marker_7 Marker_8</span></span>
<span><span class="co">#&gt; 1: 10.23486 20.60576 15.18855 8.097097  8.505908 20.941399  5.928681 18.91214</span></span>
<span><span class="co">#&gt; 2: 11.59098 20.27723 12.85960 8.364820  8.972885 18.875500  5.701071 17.67152</span></span>
<span><span class="co">#&gt; 3: 10.47562 21.02225 12.35479 7.352518  7.631617 19.761369  5.141781 18.42763</span></span>
<span><span class="co">#&gt; 4: 17.14988 17.54931 18.31479 5.859738 17.710631  8.359971 12.792568 13.64347</span></span>
<span><span class="co">#&gt; 5: 15.97808 18.50445 17.82041 5.767273 17.833800  6.589740 14.781016 13.59509</span></span>
<span><span class="co">#&gt; 6: 17.96687 18.66229 17.30338 5.723535 21.274068  7.266710 13.067404 14.49413</span></span>
<span><span class="co">#&gt;    Marker_9 Marker_10   Sample                   SuperCellId</span></span>
<span><span class="co">#&gt; 1: 15.87591 17.016521 Sample_1   SuperCell_1_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 2: 16.91084 16.569410 Sample_1   SuperCell_2_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 3: 16.71930 15.684728 Sample_1   SuperCell_3_Sample_Sample_1</span></span>
<span><span class="co">#&gt; 4: 10.41853  6.985214 Sample_2 SuperCell_498_Sample_Sample_2</span></span>
<span><span class="co">#&gt; 5: 11.66724  8.013145 Sample_2 SuperCell_499_Sample_Sample_2</span></span>
<span><span class="co">#&gt; 6: 10.67820 10.017107 Sample_2 SuperCell_500_Sample_Sample_2</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">supercell_cell_map</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">supercell_cell_map</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;                      SuperCellID     CellId   Sample</span></span>
<span><span class="co">#&gt; 1: SuperCell_715_Sample_Sample_1     Cell_1 Sample_1</span></span>
<span><span class="co">#&gt; 2:  SuperCell_42_Sample_Sample_1     Cell_2 Sample_1</span></span>
<span><span class="co">#&gt; 3: SuperCell_991_Sample_Sample_1     Cell_3 Sample_1</span></span>
<span><span class="co">#&gt; 4: SuperCell_144_Sample_Sample_2 Cell_19998 Sample_2</span></span>
<span><span class="co">#&gt; 5:  SuperCell_68_Sample_Sample_2 Cell_19999 Sample_2</span></span>
<span><span class="co">#&gt; 6: SuperCell_166_Sample_Sample_2 Cell_20000 Sample_2</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="using-runsupercellcyto-for-stratified-summarising">Using <code>runSuperCellCyto</code> for stratified summarising<a class="anchor" aria-label="anchor" href="#using-runsupercellcyto-for-stratified-summarising"></a>
</h2>
<p>As previously mentioned, we can use <code>runSuperCellCyto</code> to
perform stratified summarising, i.e., to summarise (well, meaningfully
sub-sample) each cluster or cell type. To do this, we need to change the
sample column such that it denotes the cell type or the cluster a cell
belongs to.</p>
<p>As an example, let’s first cluster a toy data with k-means:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulate some data</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simCytoData.html">simCytoData</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">markers_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Marker_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cell_id_col</span> <span class="op">&lt;-</span> <span class="st">"Cell_Id"</span></span>
<span></span>
<span><span class="co"># Run kmeans</span></span>
<span><span class="va">clust</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">dat</span><span class="op">[</span>, <span class="va">markers_col</span>, with <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>,</span>
<span>  centers <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">clust_col</span> <span class="op">&lt;-</span> <span class="st">"kmeans_clusters"</span></span>
<span><span class="va">dat</span><span class="op">[[</span><span class="va">clust_col</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"cluster_"</span>, <span class="va">clust</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span></span></code></pre></div>
<p>To perform stratified summarising, we supply the cluster column
(<code>kmeans_clusters</code> in the example above), as
<code>runSuperCellCyto</code>’s <code>sample_colname</code>
parameter.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">supercells</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runSuperCellCyto.html">runSuperCellCyto</a></span><span class="op">(</span></span>
<span>  dt <span class="op">=</span> <span class="va">dat</span>,</span>
<span>  markers <span class="op">=</span> <span class="va">markers_col</span>,</span>
<span>  sample_colname <span class="op">=</span> <span class="va">clust_col</span>,</span>
<span>  cell_id_colname <span class="op">=</span> <span class="va">cell_id_col</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now, if we look at the <code>supercell_expression_matrix</code>, each
row (each supercell) will be denoted with the cluster it belongs to, and
<em>not the biological sample it came from</em>:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Inspect the top 3 and bottom 3 of the expression matrix and some columns.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">$</span><span class="va">supercell_expression_matrix</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">$</span><span class="va">supercell_expression_matrix</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"kmeans_clusters"</span>, <span class="st">"SuperCellId"</span>, <span class="st">"Marker_10"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt;    kmeans_clusters                    SuperCellId Marker_10</span></span>
<span><span class="co">#&gt; 1:       cluster_4   SuperCell_1_Sample_cluster_4  14.64662</span></span>
<span><span class="co">#&gt; 2:       cluster_4   SuperCell_2_Sample_cluster_4  14.66858</span></span>
<span><span class="co">#&gt; 3:       cluster_4   SuperCell_3_Sample_cluster_4  14.41837</span></span>
<span><span class="co">#&gt; 4:       cluster_5 SuperCell_498_Sample_cluster_5  16.99003</span></span>
<span><span class="co">#&gt; 5:       cluster_5 SuperCell_499_Sample_cluster_5  17.09864</span></span>
<span><span class="co">#&gt; 6:       cluster_5 SuperCell_500_Sample_cluster_5  15.85447</span></span></code></pre></div>
<p>If we look at the number of supercells created and check how many
cells there were in each cluster, we will find that, for each cluster,
we get approximately <code>n_cells/20</code> where 20 is the
<code>gam</code> parameter value we used for
<code>runSuperCellCyto</code> (this is the default).</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute how many cells per cluster, and divide by 20, the gamma value.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">kmeans_clusters</span><span class="op">)</span> <span class="op">/</span> <span class="fl">20</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; cluster_1 cluster_2 cluster_3 cluster_4 cluster_5 </span></span>
<span><span class="co">#&gt;    120.25    130.30    119.75    129.70    500.00</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">supercells</span><span class="op">$</span><span class="va">supercell_expression_matrix</span><span class="op">$</span><span class="va">kmeans_clusters</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; cluster_1 cluster_2 cluster_3 cluster_4 cluster_5 </span></span>
<span><span class="co">#&gt;       120       130       120       130       500</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; R version 4.3.2 (2023-10-31)</span></span>
<span><span class="co">#&gt; Platform: x86_64-pc-linux-gnu (64-bit)</span></span>
<span><span class="co">#&gt; Running under: Ubuntu 22.04.3 LTS</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so;  LAPACK version 3.10.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt;  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">#&gt;  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">#&gt;  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">#&gt; [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: UTC</span></span>
<span><span class="co">#&gt; tzcode source: system (glibc)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] parallel  stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">#&gt; [8] base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt; [1] BiocParallel_1.34.2  SuperCellCyto_0.99.0 BiocStyle_2.28.1    </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;  [1] Matrix_1.6-1.1      jsonlite_1.8.7      compiler_4.3.2     </span></span>
<span><span class="co">#&gt;  [4] BiocManager_1.30.22 Rcpp_1.0.11         stringr_1.5.1      </span></span>
<span><span class="co">#&gt;  [7] SuperCell_1.0       jquerylib_0.1.4     systemfonts_1.0.5  </span></span>
<span><span class="co">#&gt; [10] textshaping_0.3.7   yaml_2.3.7          fastmap_1.1.1      </span></span>
<span><span class="co">#&gt; [13] lattice_0.21-9      plyr_1.8.9          R6_2.5.1           </span></span>
<span><span class="co">#&gt; [16] igraph_1.5.1        knitr_1.45          bookdown_0.37      </span></span>
<span><span class="co">#&gt; [19] desc_1.4.2          rprojroot_2.0.4     bslib_0.6.1        </span></span>
<span><span class="co">#&gt; [22] rlang_1.1.2         cachem_1.0.8        stringi_1.8.2      </span></span>
<span><span class="co">#&gt; [25] RANN_2.6.1          xfun_0.41           fs_1.6.3           </span></span>
<span><span class="co">#&gt; [28] sass_0.4.7          memoise_2.0.1       cli_3.6.1          </span></span>
<span><span class="co">#&gt; [31] pkgdown_2.0.7       magrittr_2.0.3      digest_0.6.33      </span></span>
<span><span class="co">#&gt; [34] grid_4.3.2          lifecycle_1.0.4     vctrs_0.6.5        </span></span>
<span><span class="co">#&gt; [37] evaluate_0.23       glue_1.6.2          data.table_1.14.8  </span></span>
<span><span class="co">#&gt; [40] codetools_0.2-19    ragg_1.2.6          rmarkdown_2.25     </span></span>
<span><span class="co">#&gt; [43] purrr_1.0.2         pkgconfig_2.0.3     tools_4.3.2        </span></span>
<span><span class="co">#&gt; [46] htmltools_0.5.7</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Givanna Putri, Belinda Phipson.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
